<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lorcana Card Tracker</title>
    <style>
        /* Keeping all existing styles unchanged */
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --accent-color: #4fc3dc;
            --background-color: #f5f7fa;
            --card-background: #ffffff;
            --text-color: #333333;
            --border-color: #dddddd;
            --success-color: #28a745;
            --error-color: #dc3545;
            --info-color: #17a2b8;
            --warning-color: #ffc107;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--card-background);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background-color: var(--background-color);
            border-radius: 8px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .online-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ccc;
            margin-left: 5px;
        }

        .online-indicator.online {
            background-color: var(--success-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .cloud-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ccc;
        }

        .status-indicator.connected {
            background-color: var(--success-color);
        }

        .status-indicator.error {
            background-color: var(--error-color);
        }

        .real-time-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background-color: #e8f5e9;
            border-radius: 20px;
            font-size: 14px;
            color: #2e7d32;
        }

        .real-time-status .sync-icon {
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .file-upload {
            margin-bottom: 20px;
        }

        .file-upload input {
            display: none;
        }

        .file-upload label {
            display: inline-block;
            background-color: var(--accent-color);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .file-upload label:hover {
            background-color: #3db8d1;
        }

        .view-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .view-tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            font-weight: 600;
        }

        .view-tab.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .view-tab:hover:not(.active) {
            background-color: #e9ecef;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--background-color);
            border-radius: 8px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }

        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .filter-group input, .filter-group select {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .secondary-btn {
            background-color: #6c757d;
        }

        .secondary-btn:hover {
            background-color: #5a6268;
        }

        .success-btn {
            background-color: var(--success-color);
        }

        .success-btn:hover {
            background-color: #218838;
        }

        .info-btn {
            background-color: var(--info-color);
        }

        .info-btn:hover {
            background-color: #138496;
        }

        .card-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .card-table th, .card-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .card-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            cursor: pointer;
            position: relative;
        }

        .card-table th:hover {
            background-color: var(--secondary-color);
        }

        .card-table th.sortable::after {
            content: ' ↕';
            position: absolute;
            right: 8px;
        }

        .card-table th.sort-asc::after {
            content: ' ↑';
        }

        .card-table th.sort-desc::after {
            content: ' ↓';
        }

        .card-table tr:nth-child(even) {
            background-color: var(--background-color);
        }

        .card-table tr:hover {
            background-color: rgba(79, 195, 220, 0.1);
        }

        .card-table tr.updated {
            background-color: rgba(40, 167, 69, 0.1);
            animation: highlight 2s ease-out;
        }

        @keyframes highlight {
            from { background-color: rgba(40, 167, 69, 0.3); }
            to { background-color: rgba(40, 167, 69, 0.1); }
        }

        .count-input {
            width: 60px;
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .count-input:disabled {
            background-color: #f0f0f0;
            cursor: not-allowed;
        }

        .rarity {
            font-weight: 600;
        }

        .rarity.common { color: #6c757d; }
        .rarity.uncommon { color: #28a745; }
        .rarity.rare { color: #007bff; }
        .rarity.super-rare { color: #6610f2; }
        .rarity.legendary { color: #fd7e14; }

        .color-amber { color: #ffc107; }
        .color-amethyst { color: #6f42c1; }
        .color-emerald { color: #20c997; }
        .color-ruby { color: #dc3545; }
        .color-sapphire { color: #0dcaf0; }
        .color-steel { color: #6c757d; }

        .stats-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .stats {
            flex: 1;
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background-color: var(--background-color);
            border-radius: 8px;
        }

        .stats h3 {
            margin: 0 0 10px 0;
            text-align: center;
            color: var(--secondary-color);
            font-size: 16px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 14px;
            color: var(--secondary-color);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: var(--success-color);
            color: white;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 300px;
        }

        .notification.error {
            background-color: var(--error-color);
        }

        .notification.warning {
            background-color: var(--warning-color);
        }

        .notification.show {
            opacity: 1;
        }

        .debug-panel {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #ddd;
            display: none;
        }

        .debug-panel h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .debug-panel pre {
            background-color: #eee;
            padding: 10px;
            border-radius: 3px;
            overflow: auto;
            max-height: 300px;
            font-size: 12px;
        }

        .debug-panel button {
            margin-top: 10px;
            background-color: var(--secondary-color);
        }

        .csv-preview {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 3px;
            max-height: 200px;
            overflow: auto;
            font-size: 12px;
            white-space: pre;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: var(--card-background);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--primary-color);
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--error-color);
        }

        .modal-body {
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .info-box {
            background-color: #e7f3fe;
            border-left: 6px solid #2196F3;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 0 4px 4px 0;
        }

        .warning-box {
            background-color: #fff3cd;
            border-left: 6px solid #ffc107;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 0 4px 4px 0;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 15px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
        }

        .auth-tab:first-child {
            border-radius: 4px 0 0 4px;
        }

        .auth-tab:last-child {
            border-radius: 0 4px 4px 0;
        }

        .auth-tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .view-only-message {
            text-align: center;
            padding: 15px;
            background-color: #fff3cd;
            border-radius: 5px;
            margin-bottom: 20px;
            color: #856404;
        }

        .user-stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .user-stats-table th, .user-stats-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .user-stats-table th {
            background-color: var(--secondary-color);
            color: white;
        }

        .user-stats-table tr:nth-child(even) {
            background-color: var(--background-color);
        }

        .user-stats-table tr.active-user {
            background-color: rgba(40, 167, 69, 0.1);
        }

        .activity-feed {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--background-color);
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-feed h3 {
            margin-top: 0;
            color: var(--secondary-color);
            font-size: 18px;
        }

        .activity-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-time {
            color: #6c757d;
            font-size: 12px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        .sync-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-left: 5px;
            vertical-align: middle;
        }

        .sync-indicator.syncing {
            animation: spin 1s linear infinite;
        }

        .setup-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e9;
            border-radius: 8px;
            text-align: center;
        }

        .setup-section h3 {
            margin-top: 0;
            color: #2e7d32;
        }

        .setup-section p {
            margin-bottom: 15px;
        }

        .first-time-setup {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff3cd;
            border-radius: 8px;
            text-align: center;
        }

        .first-time-setup h3 {
            margin-top: 0;
            color: #856404;
        }

        .first-time-setup p {
            margin-bottom: 15px;
        }

        .reconfigure-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #e7f3fe;
            border-radius: 8px;
            text-align: center;
        }

        .reconfigure-section h3 {
            margin-top: 0;
            color: #0c5460;
        }

        .reconfigure-section p {
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .card-table {
                font-size: 14px;
            }
            
            .card-table th, .card-table td {
                padding: 8px 10px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            
            .auth-bar {
                flex-direction: column;
                gap: 10px;
            }
            
            .stats-container {
                flex-direction: column;
            }
            
            .view-tabs {
                flex-wrap: wrap;
            }
            
            .view-tab {
                margin-bottom: 5px;
            }
            
            .real-time-status {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Lorcana Card Tracker</h1>
        
        <div class="auth-bar">
            <div class="user-info" id="userInfo">
                <button id="loginRegisterBtn">Login / Register</button>
            </div>
            
            <div class="real-time-status" id="realTimeStatus" style="display: none;">
                <span class="sync-indicator" id="syncIndicator">⟳</span>
                <span>Real-time sync active</span>
            </div>
            
            <div class="cloud-status">
                <div class="status-indicator" id="cloudStatusIndicator"></div>
                <span id="cloudStatusText">Not connected to cloud storage</span>
            </div>
        </div>
        
        <div id="viewOnlyMessage" class="view-only-message" style="display: none;">
            Please log in to edit your collection. You can currently view the tracker but cannot make changes.
        </div>
        
        <div class="file-upload">
            <label for="csvFile">Upload CSV File</label>
            <input type="file" id="csvFile" accept=".csv">
        </div>
        
        <div class="view-tabs">
            <div class="view-tab active" id="myCollectionTab">My Collection</div>
            <div class="view-tab" id="allUsersTab">All Users Collection</div>
        </div>
        
        <div class="controls">
            <div class="filter-group">
                <label for="nameFilter">Card Name</label>
                <input type="text" id="nameFilter" placeholder="Filter by name...">
            </div>
            
            <div class="filter-group">
                <label for="subtitleFilter">Subtitle</label>
                <input type="text" id="subtitleFilter" placeholder="Filter by subtitle...">
            </div>
            
            <div class="filter-group">
                <label for="setFilter">Set</label>
                <select id="setFilter">
                    <option value="">All Sets</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="colorFilter">Color</label>
                <select id="colorFilter">
                    <option value="">All Colors</option>
                    <option value="Amber">Amber</option>
                    <option value="Amethyst">Amethyst</option>
                    <option value="Emerald">Emerald</option>
                    <option value="Ruby">Ruby</option>
                    <option value="Sapphire">Sapphire</option>
                    <option value="Steel">Steel</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="rarityFilter">Rarity</label>
                <select id="rarityFilter">
                    <option value="">All Rarities</option>
                    <option value="Common">Common</option>
                    <option value="Uncommon">Uncommon</option>
                    <option value="Rare">Rare</option>
                    <option value="Super Rare">Super Rare</option>
                    <option value="Legendary">Legendary</option>
                </select>
            </div>
            
            <div class="button-group">
                <button id="resetFilters">Reset Filters</button>
                <button id="saveData" disabled>Save Local</button>
                <button id="loadData" disabled>Load Local</button>
                <button id="saveCloud" class="success-btn" disabled>Save to Cloud</button>
                <button id="loadCloud" class="secondary-btn" disabled>Load from Cloud</button>
                <button id="refreshUsers" class="info-btn">Refresh Users</button>
            </div>
        </div>
        
        <div class="stats-container">
            <div class="stats">
                <h3 id="statsTitle">My Collection Stats</h3>
                <div class="stat-item">
                    <div class="stat-value" id="totalCards">0</div>
                    <div class="stat-label">Total Cards</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalNormal">0</div>
                    <div class="stat-label">Normal Cards</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalFoil">0</div>
                    <div class="stat-label">Foil Cards</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="uniqueCards">0</div>
                    <div class="stat-label">Unique Cards</div>
                </div>
            </div>
            
            <div class="stats" id="allUsersStats" style="display: none;">
                <h3>All Users Stats</h3>
                <div class="stat-item">
                    <div class="stat-value" id="allUsersTotal">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="allUsersCards">0</div>
                    <div class="stat-label">Total Cards</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="allUsersNormal">0</div>
                    <div class="stat-label">Normal Cards</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="allUsersFoil">0</div>
                    <div class="stat-label">Foil Cards</div>
                </div>
            </div>
        </div>
        
        <table class="card-table">
            <thead>
                <tr>
                    <th class="sortable" data-column="name">Name</th>
                    <th class="sortable" data-column="subtitle">Subtitle</th>
                    <th class="sortable" data-column="set">Set</th>
                    <th class="sortable" data-column="card_number">Card #</th>
                    <th class="sortable" data-column="color_1">Color 1</th>
                    <th class="sortable" data-column="color_2">Color 2</th>
                    <th class="sortable" data-column="rarity">Rarity</th>
                    <th>Normal Count</th>
                    <th>Foil Count</th>
                </tr>
            </thead>
            <tbody id="cardTableBody">
                <!-- Cards will be inserted here -->
            </tbody>
        </table>
        
        <div id="userStatsSection" style="display: none; margin-top: 30px;">
            <h2>User Collections</h2>
            <table class="user-stats-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Status</th>
                        <th>Total Cards</th>
                        <th>Normal Cards</th>
                        <th>Foil Cards</th>
                        <th>Unique Cards</th>
                        <th>Last Activity</th>
                    </tr>
                </thead>
                <tbody id="userStatsTableBody">
                    <!-- User stats will be inserted here -->
                </tbody>
            </table>
        </div>
        
        <div id="activitySection" style="display: none; margin-top: 30px;">
            <div class="activity-feed">
                <h3>Recent Activity</h3>
                <div id="activityFeed">
                    <!-- Activity items will be inserted here -->
                </div>
            </div>
        </div>
        
        <div id="setupSection" class="setup-section" style="display: none;">
            <h3>Administrator Setup</h3>
            <p>This tracker needs to be configured by an administrator before users can register and login.</p>
            <p>Administrators need to create a GitHub Personal Access Token to store user data and enable real-time synchronization.</p>
            <button id="setupBtn" class="success-btn">Configure Tracker</button>
        </div>
        
        <div id="firstTimeSetupSection" class="first-time-setup">
            <h3>First Time Setup</h3>
            <p>Welcome to Lorcana Card Tracker! This appears to be your first time using this tracker.</p>
            <p>To get started, please register as an administrator with the username "admin".</p>
            <p>After registration, you'll need to configure the tracker with your GitHub tokens.</p>
            <button id="firstTimeSetupBtn" class="success-btn">Register as Admin</button>
        </div>
        
        <div id="reconfigureSection" class="reconfigure-section" style="display: none;">
            <h3>System Configuration Required</h3>
            <p>This system has been configured, but you need to provide the GitHub tokens to access it.</p>
            <p>Please enter the tokens to connect to the existing configuration.</p>
            <button id="reconfigureBtn" class="success-btn">Enter Configuration Tokens</button>
        </div>
        
        <div id="debugPanel" class="debug-panel">
            <h3>Debug Information</h3>
            <div id="csvPreview" class="csv-preview"></div>
            <pre id="debugInfo"></pre>
            <button id="closeDebug">Close Debug Panel</button>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <!-- Authentication Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Authentication</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="auth-tabs">
                    <div class="auth-tab active" id="loginTab">Login</div>
                    <div class="auth-tab" id="registerTab">Register</div>
                </div>
                
                <div class="auth-form active" id="loginForm">
                    <div class="form-group">
                        <label for="loginUsername">Username</label>
                        <input type="text" id="loginUsername" placeholder="Enter your username">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password">
                    </div>
                </div>
                
                <div class="auth-form" id="registerForm">
                    <div class="form-group">
                        <label for="registerUsername">Username</label>
                        <input type="text" id="registerUsername" placeholder="Choose a username">
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" placeholder="Choose a password">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" placeholder="Confirm your password">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelAuth" class="secondary-btn">Cancel</button>
                <button id="submitAuth">Login</button>
            </div>
        </div>
    </div>

    <!-- Setup Modal -->
    <div id="setupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Tracker Configuration</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="info-box">
                    <p>This tracker uses GitHub Gists to store user data and enable real-time synchronization.</p>
                </div>
                <div class="warning-box">
                    <p>You'll need to create a GitHub Personal Access Token with <strong>gist</strong> scope.</p>
                </div>
                <div class="form-group">
                    <label for="setupUserDbToken">User Database Token</label>
                    <input type="password" id="setupUserDbToken" placeholder="ghp_...">
                    <small>Create at: <a href="https://github.com/settings/tokens" target="_blank">github.com/settings/tokens</a></small>
                </div>
                <div class="form-group">
                    <label for="setupUserDbGistId">User Database Gist ID (optional)</label>
                    <input type="text" id="setupUserDbGistId" placeholder="Leave empty to create a new Gist">
                </div>
                <div class="form-group">
                    <label for="setupRealtimeToken">Real-time Data Token</label>
                    <input type="password" id="setupRealtimeToken" placeholder="ghp_...">
                </div>
                <div class="form-group">
                    <label for="setupRealtimeGistId">Real-time Data Gist ID (optional)</label>
                    <input type="text" id="setupRealtimeGistId" placeholder="Leave empty to create a new Gist">
                </div>
                <div class="form-group">
                    <label for="setupSyncInterval">Sync Interval (seconds)</label>
                    <input type="number" id="setupSyncInterval" min="5" max="60" value="10">
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelSetup" class="secondary-btn">Cancel</button>
                <button id="saveSetup" class="success-btn">Save Configuration</button>
            </div>
        </div>
    </div>

    <!-- Add User Modal (Admin Only) -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New User</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newUsername">Username</label>
                    <input type="text" id="newUsername" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label for="newEmail">Email</label>
                    <input type="email" id="newEmail" placeholder="Enter email">
                </div>
                <div class="form-group">
                    <label for="newPassword">Password</label>
                    <input type="password" id="newPassword" placeholder="Enter password">
                </div>
                <div class="form-group">
                    <label for="confirmNewPassword">Confirm Password</label>
                    <input type="password" id="confirmNewPassword" placeholder="Confirm password">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="makeAdmin"> Make this user an administrator
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelAddUser" class="secondary-btn">Cancel</button>
                <button id="submitAddUser" class="success-btn">Add User</button>
            </div>
        </div>
    </div>

    <script>
        // Initial card data from the provided CSV
        const initialCards = [
            { name: "Ariel", subtitle: "On Human Legs", set: "1", card_number: "1", color_1: "Amber", color_2: "", rarity: "Uncommon", normal: 0, foil: 0 },
            { name: "Ariel", subtitle: "Spectacular Singer", set: "1", card_number: "2", color_1: "Amber", color_2: "", rarity: "Super Rare", normal: 0, foil: 0 },
            { name: "Cinderella", subtitle: "Gentle and Kind", set: "1", card_number: "3", color_1: "Amber", color_2: "", rarity: "Uncommon", normal: 0, foil: 0 },
            { name: "Goofy", subtitle: "Musketeer", set: "1", card_number: "4", color_1: "Amber", color_2: "", rarity: "Uncommon", normal: 0, foil: 0 },
            { name: "Hades", subtitle: "King of Olympus", set: "1", card_number: "5", color_1: "Amber", color_2: "", rarity: "Rare", normal: 0, foil: 0 },
            { name: "Hades", subtitle: "Lord of the Underworld", set: "1", card_number: "6", color_1: "Amber", color_2: "", rarity: "Rare", normal: 0, foil: 0 },
            { name: "HeiHei", subtitle: "Boat Snack", set: "1", card_number: "7", color_1: "Amber", color_2: "", rarity: "Common", normal: 0, foil: 0 },
            { name: "LeFou", subtitle: "Bumbler", set: "1", card_number: "8", color_1: "Amber", color_2: "", rarity: "Uncommon", normal: 0, foil: 0 },
            { name: "Lilo", subtitle: "Making a Wish", set: "1", card_number: "9", color_1: "Amber", color_2: "", rarity: "Rare", normal: 0, foil: 0 },
            { name: "Maximus", subtitle: "Palace Horse", set: "1", card_number: "10", color_1: "Amber", color_2: "", rarity: "Super Rare", normal: 0, foil: 0 },
            { name: "Maximus", subtitle: "Relentless Pursuer", set: "1", card_number: "11", color_1: "Amber", color_2: "", rarity: "Uncommon", normal: 0, foil: 0 },
            { name: "Mickey Mouse", subtitle: "True Friend", set: "1", card_number: "12", color_1: "Amber", color_2: "", rarity: "Uncommon", normal: 0, foil: 0 },
            { name: "Minnie Mouse", subtitle: "Beloved Princess", set: "1", card_number: "13", color_1: "Amber", color_2: "", rarity: "Common", normal: 0, foil: 0 },
            { name: "Moana", subtitle: "Of Motunui", set: "1", card_number: "14", color_1: "Amber", color_2: "", rarity: "Rare", normal: 0, foil: 0 },
            { name: "Mr. Smee", subtitle: "Loyal First Mate", set: "1", card_number: "15", color_1: "Amber", color_2: "", rarity: "Common", normal: 0, foil: 0 },
            { name: "Prince Phillip", subtitle: "Dragonslayer", set: "1", card_number: "16", color_1: "Amber", color_2: "", rarity: "Uncommon", normal: 0, foil: 0 },
            { name: "Pumbaa", subtitle: "Friendly Warthog", set: "1", card_number: "17", color_1: "Amber", color_2: "", rarity: "Common", normal: 0, foil: 0 },
            { name: "Rapunzel", subtitle: "Gifted with Healing", set: "1", card_number: "18", color_1: "Amber", color_2: "", rarity: "Legendary", normal: 0, foil: 0 },
            { name: "Sebastian", subtitle: "Court Composer", set: "1", card_number: "19", color_1: "Amber", color_2: "", rarity: "Common", normal: 0, foil: 0 },
            { name: "Rhino", subtitle: "Motivational Speaker", set: "7", card_number: "1", color_1: "Amber", color_2: "Steel", rarity: "Rare", normal: 0, foil: 0 }
        ];

        // App state
        let cards = [...initialCards];
        let filteredCards = [...cards];
        let aggregatedCards = [];
        let sortColumn = null;
        let sortDirection = 'asc';
        let userDbSettings = {
            token: '',
            gistId: ''
        };
        let realtimeSettings = {
            token: '',
            gistId: '',
            syncInterval: 10,
            lastSync: 0,
            syncTimer: null
        };
        let currentUser = null;
        let authMode = 'login'; // 'login' or 'register'
        let currentView = 'my'; // 'my' or 'all'
        let allUsers = [];
        let userActivities = [];
        let lastUpdateTime = 0;
        let isConfigured = false;
        let isAdmin = false; // Track if current user is admin
        let isFirstTime = true; // Track if this is the first time setup
        let publicConfigGistId = ''; // ID of the public configuration gist
        let configData = null; // Store the configuration data

        // DOM elements
        const cardTableBody = document.getElementById('cardTableBody');
        const nameFilter = document.getElementById('nameFilter');
        const subtitleFilter = document.getElementById('subtitleFilter');
        const setFilter = document.getElementById('setFilter');
        const colorFilter = document.getElementById('colorFilter');
        const rarityFilter = document.getElementById('rarityFilter');
        const resetFiltersBtn = document.getElementById('resetFilters');
        const saveDataBtn = document.getElementById('saveData');
        const loadDataBtn = document.getElementById('loadData');
        const saveCloudBtn = document.getElementById('saveCloud');
        const loadCloudBtn = document.getElementById('loadCloud');
        const refreshUsersBtn = document.getElementById('refreshUsers');
        const csvFileInput = document.getElementById('csvFile');
        const totalCardsEl = document.getElementById('totalCards');
        const totalNormalEl = document.getElementById('totalNormal');
        const totalFoilEl = document.getElementById('totalFoil');
        const uniqueCardsEl = document.getElementById('uniqueCards');
        const allUsersTotalEl = document.getElementById('allUsersTotal');
        const allUsersCardsEl = document.getElementById('allUsersCards');
        const allUsersNormalEl = document.getElementById('allUsersNormal');
        const allUsersFoilEl = document.getElementById('allUsersFoil');
        const statsTitle = document.getElementById('statsTitle');
        const myStats = document.querySelector('.stats');
        const allUsersStats = document.getElementById('allUsersStats');
        const userStatsSection = document.getElementById('userStatsSection');
        const userStatsTableBody = document.getElementById('userStatsTableBody');
        const activitySection = document.getElementById('activitySection');
        const activityFeed = document.getElementById('activityFeed');
        const setupSection = document.getElementById('setupSection');
        const setupBtn = document.getElementById('setupBtn');
        const firstTimeSetupSection = document.getElementById('firstTimeSetupSection');
        const firstTimeSetupBtn = document.getElementById('firstTimeSetupBtn');
        const reconfigureSection = document.getElementById('reconfigureSection');
        const reconfigureBtn = document.getElementById('reconfigureBtn');
        const notification = document.getElementById('notification');
        const debugPanel = document.getElementById('debugPanel');
        const debugInfoEl = document.getElementById('debugInfo');
        const csvPreview = document.getElementById('csvPreview');
        const closeDebugBtn = document.getElementById('closeDebug');
        const authModal = document.getElementById('authModal');
        const setupModal = document.getElementById('setupModal');
        const addUserModal = document.getElementById('addUserModal');
        const cloudStatusIndicator = document.getElementById('cloudStatusIndicator');
        const cloudStatusText = document.getElementById('cloudStatusText');
        const realTimeStatus = document.getElementById('realTimeStatus');
        const syncIndicator = document.getElementById('syncIndicator');
        const userInfo = document.getElementById('userInfo');
        const loginRegisterBtn = document.getElementById('loginRegisterBtn');
        const viewOnlyMessage = document.getElementById('viewOnlyMessage');
        const myCollectionTab = document.getElementById('myCollectionTab');
        const allUsersTab = document.getElementById('allUsersTab');
        const setupUserDbTokenInput = document.getElementById('setupUserDbToken');
        const setupUserDbGistIdInput = document.getElementById('setupUserDbGistId');
        const setupRealtimeTokenInput = document.getElementById('setupRealtimeToken');
        const setupRealtimeGistIdInput = document.getElementById('setupRealtimeGistId');
        const setupSyncIntervalInput = document.getElementById('setupSyncInterval');
        const saveSetupBtn = document.getElementById('saveSetup');
        const cancelSetupBtn = document.getElementById('cancelSetup');
        const closeModalBtn = document.querySelectorAll('.close');
        const cancelAuthBtn = document.getElementById('cancelAuth');
        const submitAuthBtn = document.getElementById('submitAuth');
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginUsername = document.getElementById('loginUsername');
        const loginPassword = document.getElementById('loginPassword');
        const registerUsername = document.getElementById('registerUsername');
        const registerEmail = document.getElementById('registerEmail');
        const registerPassword = document.getElementById('registerPassword');
        const confirmPassword = document.getElementById('confirmPassword');
        
        // Add User Modal elements
        const newUsername = document.getElementById('newUsername');
        const newEmail = document.getElementById('newEmail');
        const newPassword = document.getElementById('newPassword');
        const confirmNewPassword = document.getElementById('confirmNewPassword');
        const makeAdmin = document.getElementById('makeAdmin');
        const cancelAddUserBtn = document.getElementById('cancelAddUser');
        const submitAddUserBtn = document.getElementById('submitAddUser');

        // Check if the tracker is configured
        async function checkConfiguration() {
            try {
                // We'll use a fixed gist ID for the public configuration pointer
                // This gist will contain the ID of the actual configuration gist
                const publicConfigPointerId = '9b5c44dd09c745348591e435ad0eecc0'; // Replace with your actual public config pointer gist ID
                
                console.log('Checking configuration with pointer ID:', publicConfigPointerId);
                
                if (publicConfigPointerId && publicConfigPointerId !== '9b5c44dd09c745348591e435ad0eecc0') {
                    const pointerResponse = await fetch(`https://api.github.com/gists/${publicConfigPointerId}`);
                    
                    if (!pointerResponse.ok) {
                        console.log('Failed to fetch pointer gist:', pointerResponse.status, pointerResponse.statusText);
                        throw new Error(`Failed to fetch pointer gist: ${pointerResponse.status}`);
                    }
                    
                    const pointerGistData = await pointerResponse.json();
                    console.log('Pointer gist data:', pointerGistData);
                    
                    const pointerFile = pointerGistData.files['config_pointer.json'];
                    
                    if (!pointerFile) {
                        console.log('Pointer gist does not contain config_pointer.json');
                        throw new Error('Pointer gist does not contain config_pointer.json');
                    }
                    
                    const pointerData = JSON.parse(pointerFile.content);
                    console.log('Pointer data:', pointerData);
                    
                    if (!pointerData.configGistId) {
                        console.log('Pointer data does not contain configGistId');
                        throw new Error('Pointer data does not contain configGistId');
                    }
                    
                    // Now load the actual configuration gist
                    const configResponse = await fetch(`https://api.github.com/gists/${pointerData.configGistId}`);
                    
                    if (!configResponse.ok) {
                        console.log('Failed to fetch config gist:', configResponse.status, configResponse.statusText);
                        throw new Error(`Failed to fetch config gist: ${configResponse.status}`);
                    }
                    
                    const configGistData = await configResponse.json();
                    console.log('Config gist data:', configGistData);
                    
                    const configFile = configGistData.files['config.json'];
                    
                    if (!configFile) {
                        console.log('Config gist does not contain config.json');
                        throw new Error('Config gist does not contain config.json');
                    }
                    
                    configData = JSON.parse(configFile.content);
                    console.log('Public config:', configData);
                    
                    if (configData.configured) {
                        // System is configured
                        isConfigured = true;
                        isFirstTime = false;
                        
                        // Store the gist IDs from the public config
                        userDbSettings.gistId = configData.userDbGistId;
                        realtimeSettings.gistId = configData.realtimeGistId;
                        
                        // Store the public config gist ID
                        publicConfigGistId = pointerData.configGistId;
                        
                        console.log('System is configured. User DB Gist ID:', userDbSettings.gistId, 'Realtime Gist ID:', realtimeSettings.gistId);
                        
                        updateCloudStatus();
                        updateSetupSectionVisibility();
                        return;
                    } else {
                        console.log('System is not configured (publicConfig.configured is false)');
                    }
                } else {
                    console.log('No public config pointer ID provided');
                }
                
                // If we get here, either no public config was found or it indicates not configured
                isConfigured = false;
                isFirstTime = true;
                
                updateCloudStatus();
                updateSetupSectionVisibility();
            } catch (error) {
                console.error('Error checking configuration:', error);
                isConfigured = false;
                isFirstTime = true;
                updateCloudStatus();
                updateSetupSectionVisibility();
            }
        }

        // Update setup section visibility based on user status
        function updateSetupSectionVisibility() {
            // Only show setup section if user is admin and system is not configured
            if (isAdmin && !isConfigured) {
                setupSection.style.display = 'block';
            } else {
                setupSection.style.display = 'none';
            }
            
            // Show first-time setup section if this is the first time and no admin exists
            if (isFirstTime) {
                firstTimeSetupSection.style.display = 'block';
                reconfigureSection.style.display = 'none';
            } else if (isConfigured && !userDbSettings.token) {
                // System is configured but we don't have tokens
                firstTimeSetupSection.style.display = 'none';
                reconfigureSection.style.display = 'block';
            } else {
                firstTimeSetupSection.style.display = 'none';
                reconfigureSection.style.display = 'none';
            }
        }

        // Initialize the app
        async function init() {
            await checkConfiguration();
            
            // Load tokens from localStorage if available
            const storedConfig = localStorage.getItem('lorcanaConfig');
            if (storedConfig) {
                try {
                    const config = JSON.parse(storedConfig);
                    userDbSettings.token = config.userDbToken;
                    realtimeSettings.token = config.realtimeToken;
                    userDbSettings.gistId = config.userDbGistId;
                    realtimeSettings.gistId = config.realtimeGistId;
                    console.log('Loaded config from localStorage');
                } catch (e) {
                    console.error('Error parsing stored config:', e);
                }
            }
            
            // Load user data from localStorage if available
            const storedUser = localStorage.getItem('lorcanaUser');
            if (storedUser) {
                try {
                    currentUser = JSON.parse(storedUser);
                    isAdmin = currentUser.isAdmin || false;
                    updateAuthUI();
                    loadUserData();
                } catch (e) {
                    console.error('Error parsing stored user:', e);
                }
            }
            
            // Load users from localStorage if available
            const storedUsers = localStorage.getItem('lorcanaUsers');
            if (storedUsers) {
                try {
                    allUsers = JSON.parse(storedUsers);
                } catch (e) {
                    console.error('Error parsing stored users:', e);
                    allUsers = [];
                }
            }
            
            // Load activities from localStorage if available
            const storedActivities = localStorage.getItem('lorcanaActivities');
            if (storedActivities) {
                try {
                    userActivities = JSON.parse(storedActivities);
                } catch (e) {
                    console.error('Error parsing stored activities:', e);
                    userActivities = [];
                }
            }
            
            // Load cards from localStorage if available
            const storedCards = localStorage.getItem('lorcanaCards');
            if (storedCards) {
                try {
                    cards = JSON.parse(storedCards);
                    filteredCards = [...cards];
                } catch (e) {
                    console.error('Error parsing stored cards:', e);
                }
            }
            
            // Populate set filter
            populateSetFilter();
            
            // Update UI
            updateCardTable();
            updateStats();
            updateCloudStatus();
            updateSetupSectionVisibility();
            
            // Add event listeners
            addEventListeners();
            
            // Start real-time sync if configured
            if (isConfigured && userDbSettings.token && realtimeSettings.token) {
                startRealtimeSync();
            }
        }

        // Add event listeners
        function addEventListeners() {
            // Auth modal
            loginRegisterBtn.addEventListener('click', () => {
                authModal.style.display = 'block';
            });
            
            closeModalBtn.forEach(btn => {
                btn.addEventListener('click', () => {
                    authModal.style.display = 'none';
                    setupModal.style.display = 'none';
                    addUserModal.style.display = 'none';
                });
            });
            
            cancelAuthBtn.addEventListener('click', () => {
                authModal.style.display = 'none';
            });
            
            submitAuthBtn.addEventListener('click', handleAuth);
            
            loginTab.addEventListener('click', () => {
                authMode = 'login';
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.classList.add('active');
                registerForm.classList.remove('active');
                submitAuthBtn.textContent = 'Login';
            });
            
            registerTab.addEventListener('click', () => {
                authMode = 'register';
                registerTab.classList.add('active');
                loginTab.classList.remove('active');
                registerForm.classList.add('active');
                loginForm.classList.remove('active');
                submitAuthBtn.textContent = 'Register';
            });
            
            // Setup modal
            setupBtn.addEventListener('click', () => {
                setupModal.style.display = 'block';
            });
            
            firstTimeSetupBtn.addEventListener('click', () => {
                authMode = 'register';
                registerUsername.value = 'admin';
                authModal.style.display = 'block';
                loginTab.classList.remove('active');
                registerTab.classList.add('active');
                loginForm.classList.remove('active');
                registerForm.classList.add('active');
                submitAuthBtn.textContent = 'Register';
            });
            
            reconfigureBtn.addEventListener('click', () => {
                setupModal.style.display = 'block';
            });
            
            cancelSetupBtn.addEventListener('click', () => {
                setupModal.style.display = 'none';
            });
            
            saveSetupBtn.addEventListener('click', saveSetup);
            
            // Add User modal
            cancelAddUserBtn.addEventListener('click', () => {
                addUserModal.style.display = 'none';
            });
            
            submitAddUserBtn.addEventListener('click', addNewUser);
            
            // Card table
            document.querySelectorAll('.card-table th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.column;
                    sortTable(column);
                });
            });
            
            // Filters
            nameFilter.addEventListener('input', applyFilters);
            subtitleFilter.addEventListener('input', applyFilters);
            setFilter.addEventListener('change', applyFilters);
            colorFilter.addEventListener('change', applyFilters);
            rarityFilter.addEventListener('change', applyFilters);
            
            resetFiltersBtn.addEventListener('click', resetFilters);
            
            // Data management
            saveDataBtn.addEventListener('click', saveDataToLocal);
            loadDataBtn.addEventListener('click', loadDataFromLocal);
            saveCloudBtn.addEventListener('click', saveDataToCloud);
            loadCloudBtn.addEventListener('click', loadDataFromCloud);
            refreshUsersBtn.addEventListener('click', refreshUsers);
            
            // View tabs
            myCollectionTab.addEventListener('click', () => {
                currentView = 'my';
                myCollectionTab.classList.add('active');
                allUsersTab.classList.remove('active');
                updateView();
            });
            
            allUsersTab.addEventListener('click', () => {
                currentView = 'all';
                allUsersTab.classList.add('active');
                myCollectionTab.classList.remove('active');
                updateView();
            });
            
            // File upload
            csvFileInput.addEventListener('change', handleFileUpload);
            
            // Debug panel
            closeDebugBtn.addEventListener('click', () => {
                debugPanel.style.display = 'none';
            });
            
            // Window click to close modals
            window.addEventListener('click', (event) => {
                if (event.target === authModal) {
                    authModal.style.display = 'none';
                }
                if (event.target === setupModal) {
                    setupModal.style.display = 'none';
                }
                if (event.target === addUserModal) {
                    addUserModal.style.display = 'none';
                }
            });
        }

        // Handle authentication
        async function handleAuth() {
            if (authMode === 'login') {
                // Login logic
                const username = loginUsername.value.trim();
                const password = loginPassword.value;
                
                if (!username || !password) {
                    showNotification('Username and password are required', 'error');
                    return;
                }
                
                try {
                    // Check if user exists
                    const user = allUsers.find(u => u.username === username);
                    
                    if (!user) {
                        showNotification('User not found', 'error');
                        return;
                    }
                    
                    // Verify password
                    const isPasswordValid = await verifyPassword(password, user.passwordHash);
                    
                    if (!isPasswordValid) {
                        showNotification('Invalid password', 'error');
                        return;
                    }
                    
                    // Set current user
                    currentUser = {
                        id: user.id,
                        username: user.username,
                        email: user.email,
                        isAdmin: user.isAdmin || false
                    };
                    
                    isAdmin = currentUser.isAdmin;
                    
                    // Store user in localStorage
                    localStorage.setItem('lorcanaUser', JSON.stringify(currentUser));
                    
                    // Update UI
                    updateAuthUI();
                    authModal.style.display = 'none';
                    
                    // Load user data
                    await loadUserData();
                    
                    showNotification('Login successful!', 'success');
                    
                    // If admin and system not configured, show setup section
                    if (isAdmin && !isConfigured) {
                        setupSection.style.display = 'block';
                    }
                    
                } catch (error) {
                    console.error('Login error:', error);
                    showNotification(`Login error: ${error.message}`, 'error');
                }
            } else {
                // Registration logic
                const username = registerUsername.value.trim();
                const email = registerEmail.value.trim();
                const password = registerPassword.value;
                const confirm = confirmPassword.value;
                
                if (!username || !email || !password) {
                    showNotification('All fields are required', 'error');
                    return;
                }
                
                if (password !== confirm) {
                    showNotification('Passwords do not match', 'error');
                    return;
                }
                
                try {
                    // Check if system is configured
                    if (!isConfigured && username !== 'admin') {
                        showNotification('System is not configured yet. Only admin can register.', 'error');
                        return;
                    }
                    
                    // Check if username already exists
                    if (allUsers.some(u => u.username === username)) {
                        showNotification('Username already exists', 'error');
                        return;
                    }
                    
                    // Create new user object
                    const newUser = {
                        id: Date.now().toString(),
                        username,
                        email,
                        passwordHash: await hashPassword(password),
                        createdAt: new Date().toISOString(),
                        lastActivity: new Date().toISOString(),
                        isAdmin: username === 'admin' // Make first admin if username is admin
                    };
                    
                    // Add to users array
                    allUsers.push(newUser);
                    
                    // Save users to localStorage
                    localStorage.setItem('lorcanaUsers', JSON.stringify(allUsers));
                    
                    // If system is configured and we have tokens, save to cloud
                    if (isConfigured && userDbSettings.token) {
                        try {
                            await saveUsersToDb();
                        } catch (error) {
                            console.error('Error saving users to cloud:', error);
                            // Continue with local registration even if cloud save fails
                        }
                    }
                    
                    // Log in the new user
                    currentUser = {
                        id: newUser.id,
                        username: newUser.username,
                        email: newUser.email,
                        isAdmin: newUser.isAdmin
                    };
                    
                    isAdmin = newUser.isAdmin;
                    
                    // Store user in localStorage
                    localStorage.setItem('lorcanaUser', JSON.stringify(currentUser));
                    
                    // Update UI
                    updateAuthUI();
                    authModal.style.display = 'none';
                    
                    // Load user data
                    await loadUserData();
                    
                    showNotification('Registration successful!', 'success');
                    
                    // If admin and system not configured, show setup section
                    if (isAdmin && !isConfigured) {
                        setupSection.style.display = 'block';
                    }
                    
                } catch (error) {
                    console.error('Registration error:', error);
                    showNotification(`Registration error: ${error.message}`, 'error');
                }
            }
        }

        // Add new user (admin only)
        async function addNewUser() {
            const username = newUsername.value.trim();
            const email = newEmail.value.trim();
            const password = newPassword.value;
            const confirm = confirmNewPassword.value;
            const admin = makeAdmin.checked;
            
            if (!username || !email || !password) {
                showNotification('All fields are required', 'error');
                return;
            }
            
            if (password !== confirm) {
                showNotification('Passwords do not match', 'error');
                return;
            }
            
            try {
                // Check if username already exists
                if (allUsers.some(u => u.username === username)) {
                    showNotification('Username already exists', 'error');
                    return;
                }
                
                // Create new user object
                const newUser = {
                    id: Date.now().toString(),
                    username,
                    email,
                    passwordHash: await hashPassword(password),
                    createdAt: new Date().toISOString(),
                    lastActivity: new Date().toISOString(),
                    isAdmin: admin
                };
                
                // Add to users array
                allUsers.push(newUser);
                
                // Save users to localStorage
                localStorage.setItem('lorcanaUsers', JSON.stringify(allUsers));
                
                // If system is configured and we have tokens, save to cloud
                if (isConfigured && userDbSettings.token) {
                    try {
                        await saveUsersToDb();
                    } catch (error) {
                        console.error('Error saving users to cloud:', error);
                        // Continue with local registration even if cloud save fails
                    }
                }
                
                // Add activity
                addActivity(`Admin ${currentUser.username} created new user: ${username}`);
                
                // Update UI
                refreshUsers();
                
                // Close modal
                addUserModal.style.display = 'none';
                
                // Clear form
                newUsername.value = '';
                newEmail.value = '';
                newPassword.value = '';
                confirmNewPassword.value = '';
                makeAdmin.checked = false;
                
                showNotification(`User ${username} created successfully!`, 'success');
                
            } catch (error) {
                console.error('Error adding user:', error);
                showNotification(`Error adding user: ${error.message}`, 'error');
            }
        }

        // Update authentication UI
        function updateAuthUI() {
            if (currentUser) {
                userInfo.innerHTML = `
                    <div class="user-avatar">${currentUser.username.charAt(0).toUpperCase()}</div>
                    <div>
                        <div>${currentUser.username}</div>
                        <div class="online-indicator online"></div>
                    </div>
                    ${isAdmin ? '<button id="addUserBtn" class="secondary-btn">Add User</button>' : ''}
                    <button id="logoutBtn" class="secondary-btn">Logout</button>
                `;
                
                // Add event listeners to new buttons
                const addUserBtn = document.getElementById('addUserBtn');
                const logoutBtn = document.getElementById('logoutBtn');
                
                if (addUserBtn) {
                    addUserBtn.addEventListener('click', () => {
                        addUserModal.style.display = 'block';
                    });
                }
                
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', logout);
                }
                
                // Enable/disable controls based on login status
                saveDataBtn.disabled = false;
                loadDataBtn.disabled = false;
                saveCloudBtn.disabled = !isConfigured || !userDbSettings.token;
                loadCloudBtn.disabled = !isConfigured || !userDbSettings.token;
                
                // Hide view-only message
                viewOnlyMessage.style.display = 'none';
            } else {
                userInfo.innerHTML = '<button id="loginRegisterBtn">Login / Register</button>';
                
                // Re-add event listener
                const newLoginRegisterBtn = document.getElementById('loginRegisterBtn');
                newLoginRegisterBtn.addEventListener('click', () => {
                    authModal.style.display = 'block';
                });
                
                // Disable controls
                saveDataBtn.disabled = true;
                loadDataBtn.disabled = true;
                saveCloudBtn.disabled = true;
                loadCloudBtn.disabled = true;
                
                // Show view-only message
                viewOnlyMessage.style.display = 'block';
            }
        }

        // Logout function
        function logout() {
            currentUser = null;
            isAdmin = false;
            localStorage.removeItem('lorcanaUser');
            updateAuthUI();
            updateView();
            showNotification('Logged out successfully', 'success');
        }

        // Save setup configuration
        async function saveSetup() {
            // Get values from form
            const userDbToken = setupUserDbTokenInput.value;
            const realtimeToken = setupRealtimeTokenInput.value;
            const userDbGistId = setupUserDbGistIdInput.value;
            const realtimeGistId = setupRealtimeGistIdInput.value;
            const syncInterval = parseInt(setupSyncIntervalInput.value);
            
            // Validate tokens
            if (!userDbToken || !realtimeToken) {
                showNotification('Both tokens are required', 'error');
                return;
            }
            
            // Validate tokens
            try {
                const userDbTokenValid = await validateToken(userDbToken);
                const realtimeTokenValid = await validateToken(realtimeToken);
                
                if (!userDbTokenValid) {
                    showNotification('User database token is invalid or lacks gist scope', 'error');
                    return;
                }
                
                if (!realtimeTokenValid) {
                    showNotification('Real-time token is invalid or lacks gist scope', 'error');
                    return;
                }
            } catch (error) {
                showNotification(`Token validation error: ${error.message}`, 'error');
                return;
            }
            
            // Store settings
            userDbSettings.token = userDbToken;
            userDbSettings.gistId = userDbGistId;
            realtimeSettings.token = realtimeToken;
            realtimeSettings.gistId = realtimeGistId;
            realtimeSettings.syncInterval = syncInterval;
            
            // Save to localStorage for persistence
            localStorage.setItem('lorcanaConfig', JSON.stringify({
                userDbToken: userDbToken,
                realtimeToken: realtimeToken,
                userDbGistId: userDbGistId,
                realtimeGistId: realtimeGistId
            }));
            
            // Create or update configuration gist
            try {
                const configData = {
                    configured: true,
                    userDbGistId: userDbGistId,
                    realtimeGistId: realtimeGistId,
                    lastUpdated: new Date().toISOString()
                };
                
                // If we don't have a config gist ID, create one
                if (!publicConfigGistId) {
                    const gistResponse = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${realtimeToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            description: 'Lorcana Tracker Configuration',
                            public: true,
                            files: {
                                'config.json': {
                                    content: JSON.stringify(configData, null, 2)
                                }
                            }
                        })
                    });
                    
                    if (!gistResponse.ok) {
                        throw new Error(`GitHub API error: ${gistResponse.status}`);
                    }
                    
                    const gistData = await gistResponse.json();
                    publicConfigGistId = gistData.id;
                    
                    // Update the pointer gist with the new config gist ID
                    await updatePointerGist(publicConfigGistId, realtimeToken);
                } else {
                    // Update existing config gist
                    const updateResponse = await fetch(`https://api.github.com/gists/${publicConfigGistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${realtimeToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            files: {
                                'config.json': {
                                    content: JSON.stringify(configData, null, 2)
                                }
                            }
                        })
                    });
                    
                    if (!updateResponse.ok) {
                        throw new Error(`GitHub API error: ${updateResponse.status}`);
                    }
                }
                
                isConfigured = true;
                isFirstTime = false;
                updateSetupSectionVisibility();
                updateCloudStatus();
                showNotification('Configuration saved successfully!', 'success');
                setupModal.style.display = 'none';
                
                // Enable cloud buttons
                saveCloudBtn.disabled = false;
                loadCloudBtn.disabled = false;
                
                // Start real-time sync
                startRealtimeSync();
                
                // Save users to cloud if we have any
                if (allUsers.length > 0) {
                    try {
                        await saveUsersToDb();
                    } catch (error) {
                        console.error('Error saving users to cloud after setup:', error);
                    }
                }
                
            } catch (error) {
                console.error('Error saving configuration:', error);
                showNotification(`Error saving configuration: ${error.message}`, 'error');
            }
        }

        // Update pointer gist
        async function updatePointerGist(configGistId, token) {
            const pointerData = {
                configGistId: configGistId,
                lastUpdated: new Date().toISOString()
            };
            
            const pointerResponse = await fetch(`https://api.github.com/gists/YOUR_PUBLIC_CONFIG_POINTER_ID`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    files: {
                        'config_pointer.json': {
                            content: JSON.stringify(pointerData, null, 2)
                        }
                    }
                })
            });
            
            if (!pointerResponse.ok) {
                throw new Error(`Failed to update pointer gist: ${pointerResponse.status}`);
            }
            
            return pointerResponse.json();
        }

        // Validate GitHub token
        async function validateToken(token) {
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`
                    }
                });
                
                if (!response.ok) {
                    return false;
                }
                
                const userData = await response.json();
                
                // Check if token has gist scope
                const scopesResponse = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'X-OAuth-Scopes': ''
                    }
                });
                
                const scopesHeader = scopesResponse.headers.get('X-OAuth-Scopes');
                return scopesHeader && scopesHeader.includes('gist');
            } catch (error) {
                console.error('Token validation error:', error);
                return false;
            }
        }

        // Save users to database
        async function saveUsersToDb() {
            if (!userDbSettings.token) {
                throw new Error('User database token not configured. Please ask the administrator to configure the system.');
            }
            
            try {
                let response;
                
                if (userDbSettings.gistId) {
                    // Update existing gist
                    response = await fetch(`https://api.github.com/gists/${userDbSettings.gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${userDbSettings.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            files: {
                                'users.json': {
                                    content: JSON.stringify(allUsers, null, 2)
                                }
                            }
                        })
                    });
                } else {
                    // Create new gist
                    response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${userDbSettings.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            description: 'Lorcana Tracker User Database',
                            public: true,
                            files: {
                                'users.json': {
                                    content: JSON.stringify(allUsers, null, 2)
                                }
                            }
                        })
                    });
                    
                    if (response.ok) {
                        const gistData = await response.json();
                        userDbSettings.gistId = gistData.id;
                        
                        // Update config
                        localStorage.setItem('lorcanaConfig', JSON.stringify({
                            userDbToken: userDbSettings.token,
                            realtimeToken: realtimeSettings.token,
                            userDbGistId: userDbSettings.gistId,
                            realtimeGistId: realtimeSettings.gistId
                        }));
                        
                        // Update config gist
                        if (publicConfigGistId) {
                            await fetch(`https://api.github.com/gists/${publicConfigGistId}`, {
                                method: 'PATCH',
                                headers: {
                                    'Authorization': `token ${realtimeSettings.token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    files: {
                                        'config.json': {
                                            content: JSON.stringify({
                                                configured: true,
                                                userDbGistId: userDbSettings.gistId,
                                                realtimeGistId: realtimeSettings.gistId,
                                                lastUpdated: new Date().toISOString()
                                            }, null, 2)
                                        }
                                    }
                                })
                            });
                        }
                    }
                }
                
                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMessage = `GitHub API error: ${response.status}`;
                    
                    if (response.status === 401) {
                        errorMessage += ' (Unauthorized: Check your token)';
                    } else if (response.status === 403) {
                        errorMessage += ' (Forbidden: Token may lack gist scope or be revoked)';
                    } else if (response.status === 404) {
                        errorMessage += ' (Not Found: Gist ID may be incorrect)';
                    }
                    
                    if (errorData.message) {
                        errorMessage += ` - ${errorData.message}`;
                    }
                    
                    throw new Error(errorMessage);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error saving users to database:', error);
                throw error;
            }
        }

        // Load users from database
        async function loadUsersFromDb() {
            if (!userDbSettings.gistId) {
                throw new Error('User database gist ID not configured');
            }
            
            try {
                const response = await fetch(`https://api.github.com/gists/${userDbSettings.gistId}`);
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                const gistData = await response.json();
                const usersFile = gistData.files['users.json'];
                
                if (!usersFile) {
                    throw new Error('Users file not found in gist');
                }
                
                const users = JSON.parse(usersFile.content);
                return users;
            } catch (error) {
                console.error('Error loading users from database:', error);
                throw error;
            }
        }

        // Save data to cloud
        async function saveDataToCloud() {
            if (!currentUser) {
                showNotification('Please log in to save data to cloud', 'error');
                return;
            }
            
            if (!isConfigured || !userDbSettings.token) {
                showNotification('System is not configured for cloud storage', 'error');
                return;
            }
            
            try {
                // Find current user in users array
                const userIndex = allUsers.findIndex(u => u.id === currentUser.id);
                
                if (userIndex === -1) {
                    throw new Error('User not found in users array');
                }
                
                // Update user's last activity
                allUsers[userIndex].lastActivity = new Date().toISOString();
                
                // Save users to cloud
                await saveUsersToDb();
                
                // Save cards to cloud
                await saveCardsToCloud();
                
                // Add activity
                addActivity(`${currentUser.username} saved data to cloud`);
                
                showNotification('Data saved to cloud successfully!', 'success');
            } catch (error) {
                console.error('Error saving data to cloud:', error);
                showNotification(`Error saving data to cloud: ${error.message}`, 'error');
            }
        }

        // Save cards to cloud
        async function saveCardsToCloud() {
            if (!realtimeSettings.token || !realtimeSettings.gistId) {
                throw new Error('Real-time settings not configured');
            }
            
            try {
                const response = await fetch(`https://api.github.com/gists/${realtimeSettings.gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${realtimeSettings.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: {
                            'cards.json': {
                                content: JSON.stringify(cards, null, 2)
                            }
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error saving cards to cloud:', error);
                throw error;
            }
        }

        // Load data from cloud
        async function loadDataFromCloud() {
            if (!currentUser) {
                showNotification('Please log in to load data from cloud', 'error');
                return;
            }
            
            if (!isConfigured || !userDbSettings.gistId) {
                showNotification('System is not configured for cloud storage', 'error');
                return;
            }
            
            try {
                // Load users from cloud
                const cloudUsers = await loadUsersFromDb();
                
                // Update local users array
                allUsers = cloudUsers;
                
                // Save to localStorage
                localStorage.setItem('lorcanaUsers', JSON.stringify(allUsers));
                
                // Load cards from cloud
                await loadCardsFromCloud();
                
                // Update UI
                updateCardTable();
                updateStats();
                refreshUsers();
                
                // Add activity
                addActivity(`${currentUser.username} loaded data from cloud`);
                
                showNotification('Data loaded from cloud successfully!', 'success');
            } catch (error) {
                console.error('Error loading data from cloud:', error);
                showNotification(`Error loading data from cloud: ${error.message}`, 'error');
            }
        }

        // Load cards from cloud
        async function loadCardsFromCloud() {
            if (!realtimeSettings.gistId) {
                throw new Error('Real-time gist ID not configured');
            }
            
            try {
                const response = await fetch(`https://api.github.com/gists/${realtimeSettings.gistId}`);
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                const gistData = await response.json();
                const cardsFile = gistData.files['cards.json'];
                
                if (cardsFile) {
                    const cloudCards = JSON.parse(cardsFile.content);
                    cards = cloudCards;
                    filteredCards = [...cards];
                    
                    // Save to localStorage
                    localStorage.setItem('lorcanaCards', JSON.stringify(cards));
                    
                    return cloudCards;
                }
                
                return [];
            } catch (error) {
                console.error('Error loading cards from cloud:', error);
                throw error;
            }
        }

        // Start real-time sync
        function startRealtimeSync() {
            if (realtimeSettings.syncTimer) {
                clearInterval(realtimeSettings.syncTimer);
            }
            
            if (realtimeSettings.token && realtimeSettings.gistId) {
                realtimeSettings.syncTimer = setInterval(async () => {
                    try {
                        await syncFromCloud();
                        realtimeSettings.lastSync = Date.now();
                        
                        // Update sync indicator
                        syncIndicator.classList.remove('syncing');
                        setTimeout(() => {
                            syncIndicator.classList.add('syncing');
                        }, 100);
                    } catch (error) {
                        console.error('Error during real-time sync:', error);
                    }
                }, realtimeSettings.syncInterval * 1000);
                
                // Show real-time status
                realTimeStatus.style.display = 'flex';
                syncIndicator.classList.add('syncing');
            }
        }

        // Stop real-time sync
        function stopRealtimeSync() {
            if (realtimeSettings.syncTimer) {
                clearInterval(realtimeSettings.syncTimer);
                realtimeSettings.syncTimer = null;
            }
            
            // Hide real-time status
            realTimeStatus.style.display = 'none';
        }

        // Sync from cloud
        async function syncFromCloud() {
            if (!currentUser || !realtimeSettings.gistId) {
                return;
            }
            
            try {
                const cloudCards = await loadCardsFromCloud();
                
                if (cloudCards && cloudCards.length > 0) {
                    // Check if there are changes
                    const localCardsString = JSON.stringify(cards);
                    const cloudCardsString = JSON.stringify(cloudCards);
                    
                    if (localCardsString !== cloudCardsString) {
                        // Update local cards
                        cards = cloudCards;
                        filteredCards = [...cards];
                        
                        // Save to localStorage
                        localStorage.setItem('lorcanaCards', JSON.stringify(cards));
                        
                        // Update UI
                        updateCardTable();
                        updateStats();
                        
                        // Highlight updated cards
                        document.querySelectorAll('.card-table tr').forEach(row => {
                            row.classList.add('updated');
                        });
                        
                        // Add activity
                        addActivity(`${currentUser.username} synced data from cloud`);
                    }
                }
            } catch (error) {
                console.error('Error syncing from cloud:', error);
                throw error;
            }
        }

        // Sync to cloud
        async function syncToCloud() {
            if (!currentUser || !realtimeSettings.token || !realtimeSettings.gistId) {
                return;
            }
            
            try {
                await saveCardsToCloud();
                
                // Add activity
                addActivity(`${currentUser.username} synced data to cloud`);
                
                return true;
            } catch (error) {
                console.error('Error syncing to cloud:', error);
                throw error;
            }
        }

        // Update cloud status
        function updateCloudStatus() {
            if (isConfigured && userDbSettings.gistId && realtimeSettings.gistId) {
                cloudStatusIndicator.classList.add('connected');
                cloudStatusText.textContent = 'Connected to cloud storage';
            } else {
                cloudStatusIndicator.classList.remove('connected');
                cloudStatusText.textContent = 'Not connected to cloud storage';
            }
        }

        // Save data to local storage
        function saveDataToLocal() {
            if (!currentUser) {
                showNotification('Please log in to save data locally', 'error');
                return;
            }
            
            try {
                localStorage.setItem('lorcanaCards', JSON.stringify(cards));
                showNotification('Data saved locally successfully!', 'success');
            } catch (error) {
                console.error('Error saving data locally:', error);
                showNotification(`Error saving data locally: ${error.message}`, 'error');
            }
        }

        // Load data from local storage
        function loadDataFromLocal() {
            if (!currentUser) {
                showNotification('Please log in to load data locally', 'error');
                return;
            }
            
            try {
                const storedCards = localStorage.getItem('lorcanaCards');
                
                if (storedCards) {
                    cards = JSON.parse(storedCards);
                    filteredCards = [...cards];
                    
                    updateCardTable();
                    updateStats();
                    
                    showNotification('Data loaded from local storage successfully!', 'success');
                } else {
                    showNotification('No local data found', 'warning');
                }
            } catch (error) {
                console.error('Error loading data from local storage:', error);
                showNotification(`Error loading data from local storage: ${error.message}`, 'error');
            }
        }

        // Load user data
        async function loadUserData() {
            if (!currentUser) {
                return;
            }
            
            try {
                // Load cards from cloud if configured
                if (isConfigured && realtimeSettings.gistId) {
                    await loadCardsFromCloud();
                } else {
                    // Load cards from local storage
                    const storedCards = localStorage.getItem('lorcanaCards');
                    
                    if (storedCards) {
                        cards = JSON.parse(storedCards);
                        filteredCards = [...cards];
                    }
                }
                
                // Update UI
                updateCardTable();
                updateStats();
                
                // Load users if admin
                if (isAdmin) {
                    await refreshUsers();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showNotification(`Error loading user data: ${error.message}`, 'error');
            }
        }

        // Refresh users
        async function refreshUsers() {
            if (!isAdmin) {
                showNotification('Only administrators can refresh users', 'error');
                return;
            }
            
            try {
                // Load users from cloud if configured
                if (isConfigured && userDbSettings.gistId) {
                    const cloudUsers = await loadUsersFromDb();
                    allUsers = cloudUsers;
                    
                    // Save to localStorage
                    localStorage.setItem('lorcanaUsers', JSON.stringify(allUsers));
                }
                
                // Update UI
                updateUserStatsTable();
                updateActivityFeed();
                
                showNotification('Users refreshed successfully!', 'success');
            } catch (error) {
                console.error('Error refreshing users:', error);
                showNotification(`Error refreshing users: ${error.message}`, 'error');
            }
        }

        // Update user stats table
        function updateUserStatsTable() {
            if (!isAdmin || currentView !== 'all') {
                return;
            }
            
            userStatsTableBody.innerHTML = '';
            
            allUsers.forEach(user => {
                const row = document.createElement('tr');
                
                if (currentUser && user.id === currentUser.id) {
                    row.classList.add('active-user');
                }
                
                // Calculate user stats
                const userCards = cards.filter(card => card.userId === user.id);
                const totalCards = userCards.reduce((sum, card) => sum + card.normal + card.foil, 0);
                const normalCards = userCards.reduce((sum, card) => sum + card.normal, 0);
                const foilCards = userCards.reduce((sum, card) => sum + card.foil, 0);
                const uniqueCards = userCards.length;
                
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.isAdmin ? 'Admin' : 'User'}</td>
                    <td>${totalCards}</td>
                    <td>${normalCards}</td>
                    <td>${foilCards}</td>
                    <td>${uniqueCards}</td>
                    <td>${new Date(user.lastActivity).toLocaleString()}</td>
                `;
                
                userStatsTableBody.appendChild(row);
            });
            
            // Update all users stats
            const allUsersTotal = allUsers.length;
            const allUsersCards = cards.reduce((sum, card) => sum + card.normal + card.foil, 0);
            const allUsersNormal = cards.reduce((sum, card) => sum + card.normal, 0);
            const allUsersFoil = cards.reduce((sum, card) => sum + card.foil, 0);
            
            allUsersTotalEl.textContent = allUsersTotal;
            allUsersCardsEl.textContent = allUsersCards;
            allUsersNormalEl.textContent = allUsersNormal;
            allUsersFoilEl.textContent = allUsersFoil;
        }

        // Update activity feed
        function updateActivityFeed() {
            if (!isAdmin || currentView !== 'all') {
                return;
            }
            
            activityFeed.innerHTML = '';
            
            // Show last 10 activities
            const recentActivities = userActivities.slice(-10).reverse();
            
            recentActivities.forEach(activity => {
                const activityItem = document.createElement('div');
                activityItem.classList.add('activity-item');
                
                activityItem.innerHTML = `
                    <div>${activity.message}</div>
                    <div class="activity-time">${new Date(activity.timestamp).toLocaleString()}</div>
                `;
                
                activityFeed.appendChild(activityItem);
            });
        }

        // Add activity
        function addActivity(message) {
            userActivities.push({
                message,
                timestamp: new Date().toISOString()
            });
            
            // Save to localStorage
            localStorage.setItem('lorcanaActivities', JSON.stringify(userActivities));
            
            // Update UI
            updateActivityFeed();
        }

        // Update view based on current tab
        function updateView() {
            if (currentView === 'my') {
                myCollectionTab.classList.add('active');
                allUsersTab.classList.remove('active');
                
                statsTitle.textContent = 'My Collection Stats';
                myStats.style.display = 'flex';
                allUsersStats.style.display = 'none';
                userStatsSection.style.display = 'none';
                activitySection.style.display = 'none';
                
                // Filter cards for current user
                filteredCards = cards.filter(card => card.userId === currentUser.id);
                
                // Update card table
                updateCardTable();
                updateStats();
            } else {
                allUsersTab.classList.add('active');
                myCollectionTab.classList.remove('active');
                
                statsTitle.textContent = 'All Users Stats';
                myStats.style.display = 'none';
                allUsersStats.style.display = 'flex';
                userStatsSection.style.display = 'block';
                activitySection.style.display = 'block';
                
                // Show all cards
                filteredCards = [...cards];
                
                // Update card table
                updateCardTable();
                updateStats();
                
                // Update user stats and activity
                updateUserStatsTable();
                updateActivityFeed();
            }
        }

        // Populate set filter
        function populateSetFilter() {
            const sets = [...new Set(cards.map(card => card.set))].sort();
            
            setFilter.innerHTML = '<option value="">All Sets</option>';
            
            sets.forEach(set => {
                const option = document.createElement('option');
                option.value = set;
                option.textContent = `Set ${set}`;
                setFilter.appendChild(option);
            });
        }

        // Apply filters
        function applyFilters() {
            const nameValue = nameFilter.value.toLowerCase();
            const subtitleValue = subtitleFilter.value.toLowerCase();
            const setValue = setFilter.value;
            const colorValue = colorFilter.value;
            const rarityValue = rarityFilter.value;
            
            filteredCards = cards.filter(card => {
                // Filter by current user if in "my" view
                if (currentView === 'my' && currentUser && card.userId !== currentUser.id) {
                    return false;
                }
                
                // Filter by name
                if (nameValue && !card.name.toLowerCase().includes(nameValue)) {
                    return false;
                }
                
                // Filter by subtitle
                if (subtitleValue && card.subtitle && !card.subtitle.toLowerCase().includes(subtitleValue)) {
                    return false;
                }
                
                // Filter by set
                if (setValue && card.set !== setValue) {
                    return false;
                }
                
                // Filter by color
                if (colorValue && card.color_1 !== colorValue && card.color_2 !== colorValue) {
                    return false;
                }
                
                // Filter by rarity
                if (rarityValue && card.rarity !== rarityValue) {
                    return false;
                }
                
                return true;
            });
            
            updateCardTable();
        }

        // Reset filters
        function resetFilters() {
            nameFilter.value = '';
            subtitleFilter.value = '';
            setFilter.value = '';
            colorFilter.value = '';
            rarityFilter.value = '';
            
            filteredCards = [...cards];
            
            // Re-apply current view filter
            if (currentView === 'my' && currentUser) {
                filteredCards = filteredCards.filter(card => card.userId === currentUser.id);
            }
            
            updateCardTable();
        }

        // Sort table
        function sortTable(column) {
            // Update sort direction
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            // Update sort indicators
            document.querySelectorAll('.card-table th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                
                if (th.dataset.column === column) {
                    th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
            
            // Sort cards
            filteredCards.sort((a, b) => {
                let valueA = a[column];
                let valueB = b[column];
                
                // Handle numeric values
                if (column === 'card_number') {
                    valueA = parseInt(valueA) || 0;
                    valueB = parseInt(valueB) || 0;
                }
                
                // Handle empty values
                if (valueA === undefined || valueA === null || valueA === '') {
                    valueA = '';
                }
                
                if (valueB === undefined || valueB === null || valueB === '') {
                    valueB = '';
                }
                
                // Compare
                if (typeof valueA === 'string' && typeof valueB === 'string') {
                    valueA = valueA.toLowerCase();
                    valueB = valueB.toLowerCase();
                }
                
                if (valueA < valueB) {
                    return sortDirection === 'asc' ? -1 : 1;
                }
                
                if (valueA > valueB) {
                    return sortDirection === 'asc' ? 1 : -1;
                }
                
                return 0;
            });
            
            updateCardTable();
        }

        // Update card table
        function updateCardTable() {
            cardTableBody.innerHTML = '';
            
            filteredCards.forEach(card => {
                const row = document.createElement('tr');
                
                // Add card data
                row.innerHTML = `
                    <td>${card.name}</td>
                    <td>${card.subtitle || ''}</td>
                    <td>Set ${card.set}</td>
                    <td>${card.card_number}</td>
                    <td><span class="color-${card.color_1.toLowerCase()}">${card.color_1}</span></td>
                    <td>${card.color_2 ? `<span class="color-${card.color_2.toLowerCase()}">${card.color_2}</span>` : ''}</td>
                    <td><span class="rarity ${card.rarity.toLowerCase().replace(' ', '-')}">${card.rarity}</span></td>
                    <td>
                        <input type="number" class="count-input" min="0" value="${card.normal}" 
                            data-card-id="${card.id || ''}" data-type="normal" 
                            ${!currentUser || (currentUser.id !== card.userId && !isAdmin) ? 'disabled' : ''}>
                    </td>
                    <td>
                        <input type="number" class="count-input" min="0" value="${card.foil}" 
                            data-card-id="${card.id || ''}" data-type="foil" 
                            ${!currentUser || (currentUser.id !== card.userId && !isAdmin) ? 'disabled' : ''}>
                    </td>
                `;
                
                cardTableBody.appendChild(row);
            });
            
            // Add event listeners to count inputs
            document.querySelectorAll('.count-input').forEach(input => {
                input.addEventListener('change', handleCountChange);
            });
        }

        // Handle count change
        function handleCountChange(event) {
            if (!currentUser) {
                showNotification('Please log in to edit card counts', 'error');
                return;
            }
            
            const input = event.target;
            const cardId = input.dataset.cardId;
            const type = input.dataset.type;
            const value = parseInt(input.value) || 0;
            
            // Find card
            const card = cards.find(c => c.id === cardId);
            
            if (!card) {
                showNotification('Card not found', 'error');
                return;
            }
            
            // Check if user can edit this card
            if (card.userId !== currentUser.id && !isAdmin) {
                showNotification('You can only edit your own cards', 'error');
                input.value = card[type];
                return;
            }
            
            // Update card
            card[type] = value;
            
            // Update stats
            updateStats();
            
            // Save to localStorage
            localStorage.setItem('lorcanaCards', JSON.stringify(cards));
            
            // Add activity
            addActivity(`${currentUser.username} updated ${card.name} ${type} count to ${value}`);
        }

        // Update stats
        function updateStats() {
            if (currentView === 'my' && currentUser) {
                // Filter cards for current user
                const userCards = cards.filter(card => card.userId === currentUser.id);
                
                const totalCards = userCards.reduce((sum, card) => sum + card.normal + card.foil, 0);
                const normalCards = userCards.reduce((sum, card) => sum + card.normal, 0);
                const foilCards = userCards.reduce((sum, card) => sum + card.foil, 0);
                const uniqueCards = userCards.length;
                
                totalCardsEl.textContent = totalCards;
                totalNormalEl.textContent = normalCards;
                totalFoilEl.textContent = foilCards;
                uniqueCardsEl.textContent = uniqueCards;
            } else {
                // All users stats
                const allUsersTotal = allUsers.length;
                const allUsersCards = cards.reduce((sum, card) => sum + card.normal + card.foil, 0);
                const allUsersNormal = cards.reduce((sum, card) => sum + card.normal, 0);
                const allUsersFoil = cards.reduce((sum, card) => sum + card.foil, 0);
                
                allUsersTotalEl.textContent = allUsersTotal;
                allUsersCardsEl.textContent = allUsersCards;
                allUsersNormalEl.textContent = allUsersNormal;
                allUsersFoilEl.textContent = allUsersFoil;
            }
        }

        // Handle file upload
        function handleFileUpload(event) {
            if (!currentUser) {
                showNotification('Please log in to upload a CSV file', 'error');
                return;
            }
            
            const file = event.target.files[0];
            
            if (!file) {
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const headers = lines[0].split(',').map(header => header.trim());
                    
                    const newCards = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        
                        if (!line) {
                            continue;
                        }
                        
                        const values = line.split(',');
                        
                        if (values.length < headers.length) {
                            continue;
                        }
                        
                        const card = {};
                        
                        headers.forEach((header, index) => {
                            card[header] = values[index] ? values[index].trim() : '';
                        });
                        
                        // Set default values
                        card.normal = parseInt(card.normal) || 0;
                        card.foil = parseInt(card.foil) || 0;
                        card.userId = currentUser.id;
                        
                        // Generate ID if not present
                        if (!card.id) {
                            card.id = `${card.set}-${card.card_number}-${currentUser.id}`;
                        }
                        
                        newCards.push(card);
                    }
                    
                    if (newCards.length > 0) {
                        // Add new cards
                        cards = [...cards, ...newCards];
                        
                        // Remove duplicates
                        const uniqueCards = [];
                        const cardIds = new Set();
                        
                        cards.forEach(card => {
                            const cardId = `${card.set}-${card.card_number}-${card.userId}`;
                            
                            if (!cardIds.has(cardId)) {
                                cardIds.add(cardId);
                                uniqueCards.push(card);
                            }
                        });
                        
                        cards = uniqueCards;
                        
                        // Update UI
                        filteredCards = [...cards];
                        updateCardTable();
                        updateStats();
                        
                        // Save to localStorage
                        localStorage.setItem('lorcanaCards', JSON.stringify(cards));
                        
                        showNotification(`Successfully imported ${newCards.length} cards!`, 'success');
                        
                        // Add activity
                        addActivity(`${currentUser.username} imported ${newCards.length} cards from CSV`);
                    } else {
                        showNotification('No valid cards found in CSV file', 'warning');
                    }
                } catch (error) {
                    console.error('Error parsing CSV file:', error);
                    showNotification(`Error parsing CSV file: ${error.message}`, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        // Show notification
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Hash password
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Verify password
        async function verifyPassword(password, hash) {
            const passwordHash = await hashPassword(password);
            return passwordHash === hash;
        }

        // Initialize app
        init();
    </script>
</body>
</html>

