<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lorcana Card Tracker</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --accent-color: #4fc3dc;
            --background-color: #f5f7fa;
            --card-background: #ffffff;
            --text-color: #333333;
            --border-color: #dddddd;
            --success-color: #28a745;
            --error-color: #dc3545;
            --info-color: #17a2b8;
            --warning-color: #ffc107;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--card-background);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background-color: var(--background-color);
            border-radius: 8px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .online-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ccc;
            margin-left: 5px;
        }

        .online-indicator.online {
            background-color: var(--success-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .cloud-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ccc;
        }

        .status-indicator.connected {
            background-color: var(--success-color);
        }

        .status-indicator.error {
            background-color: var(--error-color);
        }

        .real-time-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background-color: #e8f5e9;
            border-radius: 20px;
            font-size: 14px;
            color: #2e7d32;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .real-time-status:hover {
            background-color: #c8e6c9;
        }

        .real-time-status .sync-icon {
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .file-upload {
            margin-bottom: 20px;
        }

        .file-upload input {
            display: none;
        }

        .file-upload label {
            display: inline-block;
            background-color: var(--accent-color);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .file-upload label:hover {
            background-color: #3db8d1;
        }

        .view-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .view-tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            font-weight: 600;
        }

        .view-tab.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .view-tab:hover:not(.active) {
            background-color: #e9ecef;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--background-color);
            border-radius: 8px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }

        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .filter-group input, .filter-group select {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .secondary-btn {
            background-color: #6c757d;
        }

        .secondary-btn:hover {
            background-color: #5a6268;
        }

        .success-btn {
            background-color: var(--success-color);
        }

        .success-btn:hover {
            background-color: #218838;
        }

        .info-btn {
            background-color: var(--info-color);
        }

        .info-btn:hover {
            background-color: #138496;
        }

        .card-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .card-table th, .card-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .card-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            cursor: pointer;
            position: relative;
        }

        .card-table th:hover {
            background-color: var(--secondary-color);
        }

        .card-table th.sortable::after {
            content: ' ↕';
            position: absolute;
            right: 8px;
        }

        .card-table th.sort-asc::after {
            content: ' ↑';
        }

        .card-table th.sort-desc::after {
            content: ' ↓';
        }

        .card-table tr:nth-child(even) {
            background-color: var(--background-color);
        }

        .card-table tr:hover {
            background-color: rgba(79, 195, 220, 0.1);
        }

        .card-table tr.updated {
            background-color: rgba(40, 167, 69, 0.1);
            animation: highlight 2s ease-out;
        }

        @keyframes highlight {
            from { background-color: rgba(40, 167, 69, 0.3); }
            to { background-color: rgba(40, 167, 69, 0.1); }
        }

        .count-input {
            width: 60px;
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .count-input:disabled {
            background-color: #f0f0f0;
            cursor: not-allowed;
        }

        .rarity {
            font-weight: 600;
        }

        .rarity.common { color: #6c757d; }
        .rarity.uncommon { color: #28a745; }
        .rarity.rare { color: #007bff; }
        .rarity.super-rare { color: #6610f2; }
        .rarity.legendary { color: #fd7e14; }

        .color-amber { color: #ffc107; }
        .color-amethyst { color: #6f42c1; }
        .color-emerald { color: #20c997; }
        .color-ruby { color: #dc3545; }
        .color-sapphire { color: #0dcaf0; }
        .color-steel { color: #6c757d; }

        .stats-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .stats {
            flex: 1;
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background-color: var(--background-color);
            border-radius: 8px;
        }

        .stats h3 {
            margin: 0 0 10px 0;
            text-align: center;
            color: var(--secondary-color);
            font-size: 16px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 14px;
            color: var(--secondary-color);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: var(--success-color);
            color: white;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 300px;
        }

        .notification.error {
            background-color: var(--error-color);
        }

        .notification.warning {
            background-color: var(--warning-color);
        }

        .notification.show {
            opacity: 1;
        }

        .debug-panel {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #ddd;
            display: none;
        }

        .debug-panel h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .debug-panel pre {
            background-color: #eee;
            padding: 10px;
            border-radius: 3px;
            overflow: auto;
            max-height: 300px;
            font-size: 12px;
        }

        .debug-panel button {
            margin-top: 10px;
            background-color: var(--secondary-color);
        }

        .csv-preview {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 3px;
            max-height: 200px;
            overflow: auto;
            font-size: 12px;
            white-space: pre;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: var(--card-background);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--primary-color);
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--error-color);
        }

        .modal-body {
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .info-box {
            background-color: #e7f3fe;
            border-left: 6px solid #2196F3;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 0 4px 4px 0;
        }

        .warning-box {
            background-color: #fff3cd;
            border-left: 6px solid #ffc107;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 0 4px 4px 0;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 15px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
        }

        .auth-tab:first-child {
            border-radius: 4px 0 0 4px;
        }

        .auth-tab:last-child {
            border-radius: 0 4px 4px 0;
        }

        .auth-tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .view-only-message {
            text-align: center;
            padding: 15px;
            background-color: #fff3cd;
            border-radius: 5px;
            margin-bottom: 20px;
            color: #856404;
        }

        .user-stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .user-stats-table th, .user-stats-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .user-stats-table th {
            background-color: var(--secondary-color);
            color: white;
        }

        .user-stats-table tr:nth-child(even) {
            background-color: var(--background-color);
        }

        .user-stats-table tr.active-user {
            background-color: rgba(40, 167, 69, 0.1);
        }

        .activity-feed {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--background-color);
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-feed h3 {
            margin-top: 0;
            color: var(--secondary-color);
            font-size: 18px;
        }

        .activity-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-time {
            color: #6c757d;
            font-size: 12px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        .sync-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-left: 5px;
            vertical-align: middle;
        }

        .sync-indicator.syncing {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .card-table {
                font-size: 14px;
            }
            
            .card-table th, .card-table td {
                padding: 8px 10px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            
            .auth-bar {
                flex-direction: column;
                gap: 10px;
            }
            
            .stats-container {
                flex-direction: column;
            }
            
            .view-tabs {
                flex-wrap: wrap;
            }
            
            .view-tab {
                margin-bottom: 5px;
            }
            
            .real-time-status {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Lorcana Card Tracker</h1>
        
        <div class="auth-bar">
            <div class="user-info" id="userInfo">
                <button id="loginRegisterBtn">Login / Register</button>
            </div>
            
            <div class="real-time-status" id="realTimeStatus" style="display: none;">
                <span class="sync-indicator" id="syncIndicator">⟳</span>
                <span>Real-time sync active</span>
            </div>
            
            <div class="cloud-status">
                <div class="status-indicator" id="cloudStatusIndicator"></div>
                <span id="cloudStatusText">Not connected to cloud storage</span>
            </div>
        </div>
        
        <div id="viewOnlyMessage" class="view-only-message" style="display: none;">
            Please log in to edit your collection. You can currently view the tracker but cannot make changes.
        </div>
        
        <div class="file-upload">
            <label for="csvFile">Upload CSV File</label>
            <input type="file" id="csvFile" accept=".csv">
        </div>
        
        <div class="view-tabs">
            <div class="view-tab active" id="myCollectionTab">My Collection</div>
            <div class="view-tab" id="allUsersTab">All Users Collection</div>
        </div>
        
        <div class="controls">
            <div class="filter-group">
                <label for="nameFilter">Card Name</label>
                <input type="text" id="nameFilter" placeholder="Filter by name...">
            </div>
            
            <div class="filter-group">
                <label for="subtitleFilter">Subtitle</label>
                <input type="text" id="subtitleFilter" placeholder="Filter by subtitle...">
            </div>
            
            <div class="filter-group">
                <label for="setFilter">Set</label>
                <select id="setFilter">
                    <option value="">All Sets</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="colorFilter">Color</label>
                <select id="colorFilter">
                    <option value="">All Colors</option>
                    <option value="Amber">Amber</option>
                    <option value="Amethyst">Amethyst</option>
                    <option value="Emerald">Emerald</option>
                    <option value="Ruby">Ruby</option>
                    <option value="Sapphire">Sapphire</option>
                    <option value="Steel">Steel</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="rarityFilter">Rarity</label>
                <select id="rarityFilter">
                    <option value="">All Rarities</option>
                    <option value="Common">Common</option>
                    <option value="Uncommon">Uncommon</option>
                    <option value="Rare">Rare</option>
                    <option value="Super Rare">Super Rare</option>
                    <option value="Legendary">Legendary</option>
                </select>
            </div>
            
            <div class="button-group">
                <button id="resetFilters">Reset Filters</button>
                <button id="saveData" disabled>Save Local</button>
                <button id="loadData" disabled>Load Local</button>
                <button id="saveCloud" class="success-btn" disabled>Save to Cloud</button>
                <button id="loadCloud" class="secondary-btn" disabled>Load from Cloud</button>
                <button id="refreshUsers" class="info-btn">Refresh Users</button>
                <button id="realtimeSettingsBtn" class="info-btn">Real-time Settings</button>
            </div>
        </div>
        
        <div class="stats-container">
            <div class="stats">
                <h3 id="statsTitle">My Collection Stats</h3>
                <div class="stat-item">
                    <div class="stat-value" id="totalCards">0</div>
                    <div class="stat-label">Total Cards</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalNormal">0</div>
                    <div class="stat-label">Normal Cards</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalFoil">0</div>
                    <div class="stat-label">Foil Cards</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="uniqueCards">0</div>
                    <div class="stat-label">Unique Cards</div>
                </div>
            </div>
            
            <div class="stats" id="allUsersStats" style="display: none;">
                <h3>All Users Stats</h3>
                <div class="stat-item">
                    <div class="stat-value" id="allUsersTotal">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="allUsersCards">0</div>
                    <div class="stat-label">Total Cards</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="allUsersNormal">0</div>
                    <div class="stat-label">Normal Cards</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="allUsersFoil">0</div>
                    <div class="stat-label">Foil Cards</div>
                </div>
            </div>
        </div>
        
        <table class="card-table">
            <thead>
                <tr>
                    <th class="sortable" data-column="name">Name</th>
                    <th class="sortable" data-column="subtitle">Subtitle</th>
                    <th class="sortable" data-column="set">Set</th>
                    <th class="sortable" data-column="card_number">Card #</th>
                    <th class="sortable" data-column="color">Color</th>
                    <th class="sortable" data-column="rarity">Rarity</th>
                    <th>Normal Count</th>
                    <th>Foil Count</th>
                </tr>
            </thead>
            <tbody id="cardTableBody">
                <!-- Cards will be inserted here -->
            </tbody>
        </table>
        
        <div id="userStatsSection" style="display: none; margin-top: 30px;">
            <h2>User Collections</h2>
            <table class="user-stats-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Status</th>
                        <th>Total Cards</th>
                        <th>Normal Cards</th>
                        <th>Foil Cards</th>
                        <th>Unique Cards</th>
                        <th>Last Activity</th>
                    </tr>
                </thead>
                <tbody id="userStatsTableBody">
                    <!-- User stats will be inserted here -->
                </tbody>
            </table>
        </div>
        
        <div id="activitySection" style="display: none; margin-top: 30px;">
            <div class="activity-feed">
                <h3>Recent Activity</h3>
                <div id="activityFeed">
                    <!-- Activity items will be inserted here -->
                </div>
            </div>
        </div>
        
        <div id="debugPanel" class="debug-panel">
            <h3>Debug Information</h3>
            <div id="csvPreview" class="csv-preview"></div>
            <pre id="debugInfo"></pre>
            <button id="closeDebug">Close Debug Panel</button>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <!-- Authentication Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Authentication</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="auth-tabs">
                    <div class="auth-tab active" id="loginTab">Login</div>
                    <div class="auth-tab" id="registerTab">Register</div>
                </div>
                
                <div class="auth-form active" id="loginForm">
                    <div class="form-group">
                        <label for="loginUsername">Username</label>
                        <input type="text" id="loginUsername" placeholder="Enter your username">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password">
                    </div>
                </div>
                
                <div class="auth-form" id="registerForm">
                    <div class="form-group">
                        <label for="registerUsername">Username</label>
                        <input type="text" id="registerUsername" placeholder="Choose a username">
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" placeholder="Choose a password">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" placeholder="Confirm your password">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelAuth" class="secondary-btn">Cancel</button>
                <button id="submitAuth">Login</button>
            </div>
        </div>
    </div>

    <!-- Cloud Settings Modal -->
    <div id="cloudModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Cloud Storage Settings</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="info-box">
                    <p>Use your GitHub account to save your collection online. Your data will be stored as a private Gist.</p>
                </div>
                <div class="warning-box">
                    <p>Your GitHub token will be stored locally in your browser. Do not use this on public computers.</p>
                </div>
                <div class="form-group">
                    <label for="githubToken">GitHub Personal Access Token</label>
                    <input type="password" id="githubToken" placeholder="ghp_...">
                    <small>Create a token with <strong>gist</strong> scope at: <a href="https://github.com/settings/tokens" target="_blank">github.com/settings/tokens</a></small>
                </div>
                <div class="form-group">
                    <label for="gistId">Gist ID (optional)</label>
                    <input type="text" id="gistId" placeholder="Leave empty to create a new Gist">
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelCloudSettings" class="secondary-btn">Cancel</button>
                <button id="saveCloudSettings">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- User Database Settings Modal -->
    <div id="userDbModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>User Database Settings</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="info-box">
                    <p>Configure the centralized user database. This allows users to log in from any device.</p>
                </div>
                <div class="warning-box">
                    <p>This requires a GitHub Personal Access Token with <strong>gist</strong> scope.</p>
                </div>
                <div class="form-group">
                    <label for="userDbToken">GitHub Personal Access Token</label>
                    <input type="password" id="userDbToken" placeholder="ghp_...">
                </div>
                <div class="form-group">
                    <label for="userDbGistId">User Database Gist ID</label>
                    <input type="text" id="userDbGistId" placeholder="Leave empty to create a new Gist">
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelUserDbSettings" class="secondary-btn">Cancel</button>
                <button id="saveUserDbSettings">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Real-time Settings Modal -->
    <div id="realtimeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Real-time Sync Settings</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="info-box">
                    <p>Configure real-time synchronization settings. This allows you to see changes from other users in real-time.</p>
                </div>
                <div class="warning-box">
                    <p>This requires a GitHub Personal Access Token with <strong>gist</strong> scope.</p>
                </div>
                <div class="form-group">
                    <label for="realtimeToken">GitHub Personal Access Token</label>
                    <input type="password" id="realtimeToken" placeholder="ghp_...">
                </div>
                <div class="form-group">
                    <label for="realtimeGistId">Real-time Data Gist ID</label>
                    <input type="text" id="realtimeGistId" placeholder="Leave empty to create a new Gist">
                </div>
                <div class="form-group">
                    <label for="syncInterval">Sync Interval (seconds)</label>
                    <input type="number" id="syncInterval" min="5" max="60" value="10">
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelRealtimeSettings" class="secondary-btn">Cancel</button>
                <button id="saveRealtimeSettings">Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        // Initial card data from the provided CSV
        const initialCards = [
            { name: "Ariel", subtitle: "On Human Legs", set: "1", card_number: "1", color_1: "Amber", color_2: "", rarity: "Uncommon", normal: 0, foil: 0 },
            { name: "Ariel", subtitle: "Spectacular Singer", set: "1", card_number: "2", color_1: "Amber", color_2: "", rarity: "Super Rare", normal: 0, foil: 0 },
            { name: "Cinderella", subtitle: "Gentle and Kind", set: "1", card_number: "3", color_1: "Amber", color_2: "", rarity: "Uncommon", normal: 0, foil: 0 },
            { name: "Goofy", subtitle: "Musketeer", set: "1", card_number: "4", color_1: "Amber", color_2: "", rarity: "Uncommon", normal: 0, foil: 0 },
            { name: "Hades", subtitle: "King of Olympus", set: "1", card_number: "5", color_1: "Amber", color_2: "", rarity: "Rare", normal: 0, foil: 0 },
            { name: "Hades", subtitle: "Lord of the Underworld", set: "1", card_number: "6", color_1: "Amber", color_2: "", rarity: "Rare", normal: 0, foil: 0 },
            { name: "HeiHei", subtitle: "Boat Snack", set: "1", card_number: "7", color_1: "Amber", color_2: "", rarity: "Common", normal: 0, foil: 0 },
            { name: "LeFou", subtitle: "Bumbler", set: "1", card_number: "8", color_1: "Amber", color_2: "", rarity: "Uncommon", normal: 0, foil: 0 },
            { name: "Lilo", subtitle: "Making a Wish", set: "1", card_number: "9", color_1: "Amber", color_2: "", rarity: "Rare", normal: 0, foil: 0 },
            { name: "Maximus", subtitle: "Palace Horse", set: "1", card_number: "10", color_1: "Amber", color_2: "", rarity: "Super Rare", normal: 0, foil: 0 },
            { name: "Maximus", subtitle: "Relentless Pursuer", set: "1", card_number: "11", color_1: "Amber", color_2: "", rarity: "Uncommon", normal: 0, foil: 0 },
            { name: "Mickey Mouse", subtitle: "True Friend", set: "1", card_number: "12", color_1: "Amber", color_2: "", rarity: "Uncommon", normal: 0, foil: 0 },
            { name: "Minnie Mouse", subtitle: "Beloved Princess", set: "1", card_number: "13", color_1: "Amber", color_2: "", rarity: "Common", normal: 0, foil: 0 },
            { name: "Moana", subtitle: "Of Motunui", set: "1", card_number: "14", color_1: "Amber", color_2: "", rarity: "Rare", normal: 0, foil: 0 },
            { name: "Mr. Smee", subtitle: "Loyal First Mate", set: "1", card_number: "15", color_1: "Amber", color_2: "", rarity: "Common", normal: 0, foil: 0 },
            { name: "Prince Phillip", subtitle: "Dragonslayer", set: "1", card_number: "16", color_1: "Amber", color_2: "", rarity: "Uncommon", normal: 0, foil: 0 },
            { name: "Pumbaa", subtitle: "Friendly Warthog", set: "1", card_number: "17", color_1: "Amber", color_2: "", rarity: "Common", normal: 0, foil: 0 },
            { name: "Rapunzel", subtitle: "Gifted with Healing", set: "1", card_number: "18", color_1: "Amber", color_2: "", rarity: "Legendary", normal: 0, foil: 0 },
            { name: "Sebastian", subtitle: "Court Composer", set: "1", card_number: "19", color_1: "Amber", color_2: "", rarity: "Common", normal: 0, foil: 0 },
            { name: "Rhino", subtitle: "Motivational Speaker", set: "7", card_number: "1", color_1: "Amber", color_2: "Steel", rarity: "Rare", normal: 0, foil: 0 }
        ];

        // App state
        let cards = [...initialCards];
        let filteredCards = [...cards];
        let aggregatedCards = [];
        let sortColumn = null;
        let sortDirection = 'asc';
        let cloudSettings = {
            token: localStorage.getItem('githubToken') || '',
            gistId: localStorage.getItem('githubId') || ''
        };
        let userDbSettings = {
            token: localStorage.getItem('userDbToken') || '',
            gistId: localStorage.getItem('userDbGistId') || ''
        };
        let realtimeSettings = {
            token: localStorage.getItem('realtimeToken') || '',
            gistId: localStorage.getItem('realtimeGistId') || '',
            syncInterval: parseInt(localStorage.getItem('syncInterval') || '10'),
            lastSync: 0,
            syncTimer: null
        };
        let currentUser = null;
        let authMode = 'login'; // 'login' or 'register'
        let currentView = 'my'; // 'my' or 'all'
        let allUsers = [];
        let userActivities = [];
        let lastUpdateTime = 0;

        // DOM elements
        const cardTableBody = document.getElementById('cardTableBody');
        const nameFilter = document.getElementById('nameFilter');
        const subtitleFilter = document.getElementById('subtitleFilter');
        const setFilter = document.getElementById('setFilter');
        const colorFilter = document.getElementById('colorFilter');
        const rarityFilter = document.getElementById('rarityFilter');
        const resetFiltersBtn = document.getElementById('resetFilters');
        const saveDataBtn = document.getElementById('saveData');
        const loadDataBtn = document.getElementById('loadData');
        const saveCloudBtn = document.getElementById('saveCloud');
        const loadCloudBtn = document.getElementById('loadCloud');
        const refreshUsersBtn = document.getElementById('refreshUsers');
        const realtimeSettingsBtn = document.getElementById('realtimeSettingsBtn');
        const csvFileInput = document.getElementById('csvFile');
        const totalCardsEl = document.getElementById('totalCards');
        const totalNormalEl = document.getElementById('totalNormal');
        const totalFoilEl = document.getElementById('totalFoil');
        const uniqueCardsEl = document.getElementById('uniqueCards');
        const allUsersTotalEl = document.getElementById('allUsersTotal');
        const allUsersCardsEl = document.getElementById('allUsersCards');
        const allUsersNormalEl = document.getElementById('allUsersNormal');
        const allUsersFoilEl = document.getElementById('allUsersFoil');
        const statsTitle = document.getElementById('statsTitle');
        const myStats = document.querySelector('.stats');
        const allUsersStats = document.getElementById('allUsersStats');
        const userStatsSection = document.getElementById('userStatsSection');
        const userStatsTableBody = document.getElementById('userStatsTableBody');
        const activitySection = document.getElementById('activitySection');
        const activityFeed = document.getElementById('activityFeed');
        const notification = document.getElementById('notification');
        const debugPanel = document.getElementById('debugPanel');
        const debugInfo = document.getElementById('debugInfo');
        const csvPreview = document.getElementById('csvPreview');
        const closeDebugBtn = document.getElementById('closeDebug');
        const cloudModal = document.getElementById('cloudModal');
        const authModal = document.getElementById('authModal');
        const userDbModal = document.getElementById('userDbModal');
        const realtimeModal = document.getElementById('realtimeModal');
        const cloudStatusIndicator = document.getElementById('cloudStatusIndicator');
        const cloudStatusText = document.getElementById('cloudStatusText');
        const realTimeStatus = document.getElementById('realTimeStatus');
        const syncIndicator = document.getElementById('syncIndicator');
        const userInfo = document.getElementById('userInfo');
        const loginRegisterBtn = document.getElementById('loginRegisterBtn');
        const viewOnlyMessage = document.getElementById('viewOnlyMessage');
        const myCollectionTab = document.getElementById('myCollectionTab');
        const allUsersTab = document.getElementById('allUsersTab');
        const githubTokenInput = document.getElementById('githubToken');
        const gistIdInput = document.getElementById('gistId');
        const userDbTokenInput = document.getElementById('userDbToken');
        const userDbGistIdInput = document.getElementById('userDbGistId');
        const realtimeTokenInput = document.getElementById('realtimeToken');
        const realtimeGistIdInput = document.getElementById('realtimeGistId');
        const syncIntervalInput = document.getElementById('syncInterval');
        const saveCloudSettingsBtn = document.getElementById('saveCloudSettings');
        const cancelCloudSettingsBtn = document.getElementById('cancelCloudSettings');
        const saveUserDbSettingsBtn = document.getElementById('saveUserDbSettings');
        const cancelUserDbSettingsBtn = document.getElementById('cancelUserDbSettings');
        const saveRealtimeSettingsBtn = document.getElementById('saveRealtimeSettings');
        const cancelRealtimeSettingsBtn = document.getElementById('cancelRealtimeSettings');
        const closeModalBtn = document.querySelectorAll('.close');
        const cancelAuthBtn = document.getElementById('cancelAuth');
        const submitAuthBtn = document.getElementById('submitAuth');
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginUsername = document.getElementById('loginUsername');
        const loginPassword = document.getElementById('loginPassword');
        const registerUsername = document.getElementById('registerUsername');
        const registerEmail = document.getElementById('registerEmail');
        const registerPassword = document.getElementById('registerPassword');
        const confirmPassword = document.getElementById('confirmPassword');

        // Initialize the app
        function init() {
            checkAuthStatus();
            populateSetFilter();
            renderTable();
            updateStats();
            updateCloudStatus();
            
            // Event listeners
            nameFilter.addEventListener('input', applyFilters);
            subtitleFilter.addEventListener('input', applyFilters);
            setFilter.addEventListener('change', applyFilters);
            colorFilter.addEventListener('change', applyFilters);
            rarityFilter.addEventListener('change', applyFilters);
            resetFiltersBtn.addEventListener('click', resetFilters);
            saveDataBtn.addEventListener('click', saveData);
            loadDataBtn.addEventListener('click', loadData);
            saveCloudBtn.addEventListener('click', openCloudSettings);
            loadCloudBtn.addEventListener('click', openCloudSettings);
            refreshUsersBtn.addEventListener('click', refreshUserData);
            realtimeSettingsBtn.addEventListener('click', openRealtimeSettings);
            csvFileInput.addEventListener('change', handleFileUpload);
            closeDebugBtn.addEventListener('click', () => {
                debugPanel.style.display = 'none';
            });
            
            // Add click event listener to real-time status
            realTimeStatus.addEventListener('click', openRealtimeSettings);
            
            // View tab event listeners
            myCollectionTab.addEventListener('click', () => switchView('my'));
            allUsersTab.addEventListener('click', () => switchView('all'));
            
            // Auth event listeners
            loginRegisterBtn.addEventListener('click', openAuthModal);
            cancelAuthBtn.addEventListener('click', closeAuthModal);
            submitAuthBtn.addEventListener('click', handleAuth);
            loginTab.addEventListener('click', () => switchAuthMode('login'));
            registerTab.addEventListener('click', () => switchAuthMode('register'));
            
            // Cloud modal event listeners
            saveCloudSettingsBtn.addEventListener('click', saveCloudSettings);
            cancelCloudSettingsBtn.addEventListener('click', closeCloudModal);
            
            // User DB modal event listeners
            saveUserDbSettingsBtn.addEventListener('click', saveUserDbSettings);
            cancelUserDbSettingsBtn.addEventListener('click', closeUserDbModal);
            
            // Real-time modal event listeners
            saveRealtimeSettingsBtn.addEventListener('click', saveRealtimeSettings);
            cancelRealtimeSettingsBtn.addEventListener('click', closeRealtimeModal);
            
            // Close modal when clicking outside
            window.addEventListener('click', (event) => {
                if (event.target === authModal) {
                    closeAuthModal();
                }
                if (event.target === cloudModal) {
                    closeCloudModal();
                }
                if (event.target === userDbModal) {
                    closeUserDbModal();
                }
                if (event.target === realtimeModal) {
                    closeRealtimeModal();
                }
            });
            
            // Close modal buttons
            closeModalBtn.forEach(btn => {
                btn.addEventListener('click', () => {
                    authModal.style.display = 'none';
                    cloudModal.style.display = 'none';
                    userDbModal.style.display = 'none';
                    realtimeModal.style.display = 'none';
                });
            });
            
            // Sorting event listeners
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.column;
                    handleSort(column);
                });
            });
        }

        // Switch between views
        function switchView(view) {
            currentView = view;
            
            if (view === 'my') {
                myCollectionTab.classList.add('active');
                allUsersTab.classList.remove('active');
                myStats.style.display = 'flex';
                allUsersStats.style.display = 'none';
                userStatsSection.style.display = 'none';
                activitySection.style.display = 'none';
                statsTitle.textContent = 'My Collection Stats';
                
                // Load user's collection
                if (currentUser) {
                    loadUserCollection();
                } else {
                    cards = [...initialCards];
                    filteredCards = [...cards];
                }
            } else {
                myCollectionTab.classList.remove('active');
                allUsersTab.classList.add('active');
                myStats.style.display = 'none';
                allUsersStats.style.display = 'flex';
                userStatsSection.style.display = 'block';
                activitySection.style.display = 'block';
                
                // Load aggregated collection
                loadAggregatedCollection();
                loadUserActivities();
            }
            
            populateSetFilter();
            applyFilters();
            updateStats();
        }

        // Check authentication status
        function checkAuthStatus() {
            const userData = localStorage.getItem('lorcanaCurrentUser');
            if (userData) {
                currentUser = JSON.parse(userData);
                updateAuthUI();
                startRealtimeSync();
            } else {
                currentUser = null;
                updateAuthUI();
                stopRealtimeSync();
            }
        }

        // Update authentication UI
        function updateAuthUI() {
            if (currentUser) {
                // User is logged in
                userInfo.innerHTML = `
                    <div class="user-avatar">${currentUser.username.charAt(0).toUpperCase()}</div>
                    <span>${currentUser.username}</span>
                    <div class="online-indicator online"></div>
                    <button id="logoutBtn" class="secondary-btn">Logout</button>
                `;
                
                // Enable edit controls
                saveDataBtn.disabled = false;
                loadDataBtn.disabled = false;
                saveCloudBtn.disabled = false;
                loadCloudBtn.disabled = false;
                viewOnlyMessage.style.display = 'none';
                
                // Show real-time status
                realTimeStatus.style.display = 'flex';
                
                // Add logout button event listener
                document.getElementById('logoutBtn').addEventListener('click', logoutUser);
                
                // Load user's collection
                if (currentView === 'my') {
                    loadUserCollection();
                }
            } else {
                // User is not logged in
                userInfo.innerHTML = '<button id="loginRegisterBtn">Login / Register</button>';
                
                // Disable edit controls
                saveDataBtn.disabled = true;
                loadDataBtn.disabled = true;
                saveCloudBtn.disabled = true;
                loadCloudBtn.disabled = true;
                viewOnlyMessage.style.display = 'block';
                
                // Hide real-time status
                realTimeStatus.style.display = 'none';
                
                // Add login/register button event listener
                document.getElementById('loginRegisterBtn').addEventListener('click', openAuthModal);
                
                // Reset to default card collection
                if (currentView === 'my') {
                    cards = [...initialCards];
                    filteredCards = [...cards];
                    renderTable();
                    updateStats();
                }
            }
        }

        // Start real-time synchronization
        function startRealtimeSync() {
            if (!currentUser || !realtimeSettings.token) return;
            
            // Clear any existing timer
            if (realtimeSettings.syncTimer) {
                clearInterval(realtimeSettings.syncTimer);
            }
            
            // Set up periodic sync
            realtimeSettings.syncTimer = setInterval(() => {
                syncRealtimeData();
            }, realtimeSettings.syncInterval * 1000);
            
            // Initial sync
            syncRealtimeData();
        }

        // Stop real-time synchronization
        function stopRealtimeSync() {
            if (realtimeSettings.syncTimer) {
                clearInterval(realtimeSettings.syncTimer);
                realtimeSettings.syncTimer = null;
            }
        }

        // Sync real-time data
        async function syncRealtimeData() {
            if (!currentUser || !realtimeSettings.token) return;
            
            try {
                // Show syncing indicator
                syncIndicator.classList.add('syncing');
                
                // Get latest data from cloud
                const realtimeData = await getRealtimeDataFromCloud();
                
                // Check if there are updates
                if (realtimeData.lastUpdate > lastUpdateTime) {
                    lastUpdateTime = realtimeData.lastUpdate;
                    
                    // Update aggregated data if in all users view
                    if (currentView === 'all') {
                        await loadAggregatedCollection();
                        await loadUserActivities();
                        applyFilters();
                        updateStats();
                        
                        // Show notification about updates
                        showNotification('Collection data updated', false, 2000);
                    }
                }
                
                // Update user's last activity
                await updateUserActivity();
                
            } catch (error) {
                console.error('Error syncing real-time data:', error);
            } finally {
                // Hide syncing indicator
                syncIndicator.classList.remove('syncing');
            }
        }

        // Get real-time data from cloud
        async function getRealtimeDataFromCloud() {
            if (!realtimeSettings.token || !realtimeSettings.gistId) {
                // Return default data if not configured
                return {
                    collections: {},
                    activities: [],
                    lastUpdate: Date.now()
                };
            }
            
            try {
                const response = await fetch(`https://api.github.com/gists/${realtimeSettings.gistId}`, {
                    headers: {
                        'Authorization': `token ${realtimeSettings.token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                const gistData = await response.json();
                const fileContent = gistData.files['realtime-data.json'].content;
                return JSON.parse(fileContent);
            } catch (error) {
                console.error('Error fetching real-time data from cloud:', error);
                // Return default data
                return {
                    collections: {},
                    activities: [],
                    lastUpdate: Date.now()
                };
            }
        }

        // Save real-time data to cloud
        async function saveRealtimeDataToCloud(data) {
            if (!realtimeSettings.token) {
                console.error('Real-time token not configured');
                return;
            }
            
            try {
                const gistData = {
                    description: 'Lorcana Card Tracker Real-time Data',
                    public: false,
                    files: {
                        'realtime-data.json': {
                            content: JSON.stringify(data)
                        }
                    }
                };
                
                let url;
                let method;
                
                if (realtimeSettings.gistId) {
                    // Update existing gist
                    url = `https://api.github.com/gists/${realtimeSettings.gistId}`;
                    method = 'PATCH';
                } else {
                    // Create new gist
                    url = 'https://api.github.com/gists';
                    method = 'POST';
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `token ${realtimeSettings.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(gistData)
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                const responseData = await response.json();
                
                // Save gist ID if this was a new gist
                if (!realtimeSettings.gistId) {
                    realtimeSettings.gistId = responseData.id;
                    localStorage.setItem('realtimeGistId', realtimeSettings.gistId);
                }
            } catch (error) {
                console.error('Error saving real-time data to cloud:', error);
            }
        }

        // Update user activity
        async function updateUserActivity() {
            if (!currentUser) return;
            
            try {
                // Get current real-time data
                const realtimeData = await getRealtimeDataFromCloud();
                
                // Update user's last activity
                if (!realtimeData.userActivities) {
                    realtimeData.userActivities = {};
                }
                
                realtimeData.userActivities[currentUser.id] = {
                    username: currentUser.username,
                    lastActivity: Date.now(),
                    isOnline: true
                };
                
                // Add activity log
                if (!realtimeData.activities) {
                    realtimeData.activities = [];
                }
                
                // Add new activity
                realtimeData.activities.unshift({
                    userId: currentUser.id,
                    username: currentUser.username,
                    action: 'active',
                    timestamp: Date.now()
                });
                
                // Keep only last 50 activities
                if (realtimeData.activities.length > 50) {
                    realtimeData.activities = realtimeData.activities.slice(0, 50);
                }
                
                // Update last update time
                realtimeData.lastUpdate = Date.now();
                
                // Save to cloud
                await saveRealtimeDataToCloud(realtimeData);
            } catch (error) {
                console.error('Error updating user activity:', error);
            }
        }

        // Log user activity
        async function logUserActivity(action, details = {}) {
            if (!currentUser) return;
            
            try {
                // Get current real-time data
                const realtimeData = await getRealtimeDataFromCloud();
                
                // Add activity log
                if (!realtimeData.activities) {
                    realtimeData.activities = [];
                }
                
                // Add new activity
                realtimeData.activities.unshift({
                    userId: currentUser.id,
                    username: currentUser.username,
                    action: action,
                    details: details,
                    timestamp: Date.now()
                });
                
                // Keep only last 50 activities
                if (realtimeData.activities.length > 50) {
                    realtimeData.activities = realtimeData.activities.slice(0, 50);
                }
                
                // Update last update time
                realtimeData.lastUpdate = Date.now();
                
                // Save to cloud
                await saveRealtimeDataToCloud(realtimeData);
            } catch (error) {
                console.error('Error logging user activity:', error);
            }
        }

        // Load user activities
        async function loadUserActivities() {
            try {
                const realtimeData = await getRealtimeDataFromCloud();
                const activities = realtimeData.activities || [];
                
                // Clear activity feed
                activityFeed.innerHTML = '';
                
                // Add activities to feed
                activities.forEach(activity => {
                    const activityItem = document.createElement('div');
                    activityItem.className = 'activity-item';
                    
                    const time = new Date(activity.timestamp);
                    const timeString = time.toLocaleTimeString();
                    
                    let actionText = '';
                    switch (activity.action) {
                        case 'active':
                            actionText = 'is now active';
                            break;
                        case 'update':
                            actionText = `updated ${activity.details.cardName}`;
                            break;
                        case 'add':
                            actionText = `added ${activity.details.cardName}`;
                            break;
                        case 'login':
                            actionText = 'logged in';
                            break;
                        case 'logout':
                            actionText = 'logged out';
                            break;
                        default:
                            actionText = activity.action;
                    }
                    
                    activityItem.innerHTML = `
                        <strong>${activity.username}</strong> ${actionText}
                        <div class="activity-time">${timeString}</div>
                    `;
                    
                    activityFeed.appendChild(activityItem);
                });
                
                if (activities.length === 0) {
                    activityFeed.innerHTML = '<div class="activity-item">No recent activity</div>';
                }
            } catch (error) {
                console.error('Error loading user activities:', error);
                activityFeed.innerHTML = '<div class="activity-item">Error loading activities</div>';
            }
        }

        // Open authentication modal
        function openAuthModal() {
            authModal.style.display = 'block';
            switchAuthMode('login');
        }

        // Close authentication modal
        function closeAuthModal() {
            authModal.style.display = 'none';
            // Clear form fields
            loginUsername.value = '';
            loginPassword.value = '';
            registerUsername.value = '';
            registerEmail.value = '';
            registerPassword.value = '';
            confirmPassword.value = '';
        }

        // Switch between login and register modes
        function switchAuthMode(mode) {
            authMode = mode;
            
            if (mode === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.classList.add('active');
                registerForm.classList.remove('active');
                submitAuthBtn.textContent = 'Login';
            } else {
                loginTab.classList.remove('active');
                registerTab.classList.add('active');
                loginForm.classList.remove('active');
                registerForm.classList.add('active');
                submitAuthBtn.textContent = 'Register';
            }
        }

        // Handle authentication (login or register)
        function handleAuth() {
            if (authMode === 'login') {
                loginUser();
            } else {
                registerUser();
            }
        }

        // Simple hash function for passwords (not secure for production, but better than plaintext)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            return hash.toString();
        }

        // Get users from cloud database
        async function getUsersFromCloud() {
            if (!userDbSettings.token || !userDbSettings.gistId) {
                // If user database is not configured, try to use localStorage as fallback
                return JSON.parse(localStorage.getItem('lorcanaUsers') || '[]');
            }
            
            try {
                const response = await fetch(`https://api.github.com/gists/${userDbSettings.gistId}`, {
                    headers: {
                        'Authorization': `token ${userDbSettings.token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                const gistData = await response.json();
                const fileContent = gistData.files['user-database.json'].content;
                return JSON.parse(fileContent);
            } catch (error) {
                console.error('Error fetching users from cloud:', error);
                // Fallback to localStorage
                return JSON.parse(localStorage.getItem('lorcanaUsers') || '[]');
            }
        }

        // Save users to cloud database
        async function saveUsersToCloud(users) {
            if (!userDbSettings.token) {
                // If user database is not configured, save to localStorage as fallback
                localStorage.setItem('lorcanaUsers', JSON.stringify(users));
                return;
            }
            
            try {
                const data = {
                    description: 'Lorcana Card Tracker User Database',
                    public: false,
                    files: {
                        'user-database.json': {
                            content: JSON.stringify(users)
                        }
                    }
                };
                
                let url;
                let method;
                
                if (userDbSettings.gistId) {
                    // Update existing gist
                    url = `https://api.github.com/gists/${userDbSettings.gistId}`;
                    method = 'PATCH';
                } else {
                    // Create new gist
                    url = 'https://api.github.com/gists';
                    method = 'POST';
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `token ${userDbSettings.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                const gistData = await response.json();
                
                // Save gist ID if this was a new gist
                if (!userDbSettings.gistId) {
                    userDbSettings.gistId = gistData.id;
                    localStorage.setItem('userDbGistId', userDbSettings.gistId);
                }
                
                // Also save to localStorage as backup
                localStorage.setItem('lorcanaUsers', JSON.stringify(users));
            } catch (error) {
                console.error('Error saving users to cloud:', error);
                // Fallback to localStorage
                localStorage.setItem('lorcanaUsers', JSON.stringify(users));
            }
        }

        // Register a new user
        async function registerUser() {
            const username = registerUsername.value.trim();
            const email = registerEmail.value.trim();
            const password = registerPassword.value;
            const confirmPass = confirmPassword.value;
            
            // Validation
            if (!username || !email || !password || !confirmPass) {
                showNotification('Please fill in all fields', true);
                return;
            }
            
            if (password !== confirmPass) {
                showNotification('Passwords do not match', true);
                return;
            }
            
            // Show loading state
            submitAuthBtn.disabled = true;
            submitAuthBtn.innerHTML = '<span class="loading"></span> Registering...';
            
            try {
                // Get existing users from cloud
                const users = await getUsersFromCloud();
                
                // Check if username already exists
                if (users.find(user => user.username === username)) {
                    showNotification('Username already exists', true);
                    submitAuthBtn.disabled = false;
                    submitAuthBtn.textContent = 'Register';
                    return;
                }
                
                // Create new user
                const newUser = {
                    id: Date.now().toString(),
                    username,
                    email,
                    password: simpleHash(password), // Store hashed password
                    createdAt: new Date().toISOString()
                };
                
                // Save user to cloud
                users.push(newUser);
                await saveUsersToCloud(users);
                
                // Log in the new user
                currentUser = newUser;
                localStorage.setItem('lorcanaCurrentUser', JSON.stringify(newUser));
                
                // Update UI
                updateAuthUI();
                closeAuthModal();
                showNotification('Registration successful!');
                
                // Log user activity
                logUserActivity('login');
                
                // Initialize user's collection
                initializeUserCollection();
            } catch (error) {
                showNotification(`Registration failed: ${error.message}`, true);
                console.error(error);
            } finally {
                submitAuthBtn.disabled = false;
                submitAuthBtn.textContent = 'Register';
            }
        }

        // Login an existing user
        async function loginUser() {
            const username = loginUsername.value.trim();
            const password = loginPassword.value;
            
            // Validation
            if (!username || !password) {
                showNotification('Please enter username and password', true);
                return;
            }
            
            // Show loading state
            submitAuthBtn.disabled = true;
            submitAuthBtn.innerHTML = '<span class="loading"></span> Logging in...';
            
            try {
                // Get users from cloud
                const users = await getUsersFromCloud();
                
                // Find user
                const hashedPassword = simpleHash(password);
                const user = users.find(u => u.username === username && u.password === hashedPassword);
                
                if (!user) {
                    showNotification('Invalid username or password', true);
                    submitAuthBtn.disabled = false;
                    submitAuthBtn.textContent = 'Login';
                    return;
                }
                
                // Log in the user
                currentUser = user;
                localStorage.setItem('lorcanaCurrentUser', JSON.stringify(user));
                
                // Update UI
                updateAuthUI();
                closeAuthModal();
                showNotification('Login successful!');
                
                // Log user activity
                logUserActivity('login');
                
                // Load user's collection
                if (currentView === 'my') {
                    loadUserCollection();
                }
            } catch (error) {
                showNotification(`Login failed: ${error.message}`, true);
                console.error(error);
            } finally {
                submitAuthBtn.disabled = false;
                submitAuthBtn.textContent = 'Login';
            }
        }

        // Logout the current user
        async function logoutUser() {
            // Log user activity
            await logUserActivity('logout');
            
            currentUser = null;
            localStorage.removeItem('lorcanaCurrentUser');
            updateAuthUI();
            showNotification('Logged out successfully');
            
            // Switch to my collection view
            switchView('my');
        }

        // Initialize user's collection
        function initializeUserCollection() {
            const userCollectionKey = `lorcanaCollection_${currentUser.id}`;
            localStorage.setItem(userCollectionKey, JSON.stringify(cards));
        }

        // Load user's collection
        function loadUserCollection() {
            const userCollectionKey = `lorcanaCollection_${currentUser.id}`;
            const savedData = localStorage.getItem(userCollectionKey);
            
            if (savedData) {
                cards = JSON.parse(savedData);
                filteredCards = [...cards];
                populateSetFilter();
                renderTable();
                updateStats();
            }
        }

        // Load aggregated collection from all users
        async function loadAggregatedCollection() {
            try {
                // Get all users from cloud
                allUsers = await getUsersFromCloud();
                
                // Get real-time data
                const realtimeData = await getRealtimeDataFromCloud();
                const collections = realtimeData.collections || {};
                
                // Create a map to aggregate card data
                const cardMap = new Map();
                
                // Process each user's collection
                for (const user of allUsers) {
                    const userCollectionKey = `lorcanaCollection_${user.id}`;
                    const userCollection = JSON.parse(localStorage.getItem(userCollectionKey) || '[]');
                    
                    // Also check if collection is in real-time data
                    const realtimeCollection = collections[user.id] || [];
                    const mergedCollection = [...userCollection];
                    
                    // Merge with real-time data if available
                    realtimeCollection.forEach(realtimeCard => {
                        const existingCard = mergedCollection.find(c => 
                            c.set === realtimeCard.set && c.card_number === realtimeCard.card_number
                        );
                        
                        if (existingCard) {
                            existingCard.normal = Math.max(existingCard.normal, realtimeCard.normal);
                            existingCard.foil = Math.max(existingCard.foil, realtimeCard.foil);
                        } else {
                            mergedCollection.push({...realtimeCard});
                        }
                    });
                    
                    mergedCollection.forEach(card => {
                        const key = `${card.set}-${card.card_number}`;
                        
                        if (cardMap.has(key)) {
                            const existingCard = cardMap.get(key);
                            existingCard.normal += card.normal;
                            existingCard.foil += card.foil;
                            existingCard.userCount = (existingCard.userCount || 0) + 1;
                        } else {
                            cardMap.set(key, {
                                ...card,
                                normal: card.normal,
                                foil: card.foil,
                                userCount: 1
                            });
                        }
                    });
                }
                
                // Convert map to array
                aggregatedCards = Array.from(cardMap.values());
                cards = aggregatedCards;
                filteredCards = [...cards];
                
                // Update user stats
                updateUserStats();
            } catch (error) {
                showNotification(`Error loading aggregated data: ${error.message}`, true);
                console.error(error);
            }
        }

        // Update user statistics table
        function updateUserStats() {
            userStatsTableBody.innerHTML = '';
            
            let totalCards = 0;
            let totalNormal = 0;
            let totalFoil = 0;
            
            // Get real-time data for user activities
            const userActivities = {};
            if (realtimeSettings.token && realtimeSettings.gistId) {
                getRealtimeDataFromCloud().then(realtimeData => {
                    const activities = realtimeData.userActivities || {};
                    Object.keys(activities).forEach(userId => {
                        userActivities[userId] = activities[userId];
                    });
                }).catch(error => {
                    console.error('Error getting user activities:', error);
                });
            }
            
            allUsers.forEach(user => {
                const userCollectionKey = `lorcanaCollection_${user.id}`;
                const userCollection = JSON.parse(localStorage.getItem(userCollectionKey) || '[]');
                
                let userTotalNormal = 0;
                let userTotalFoil = 0;
                let userUniqueCards = 0;
                
                userCollection.forEach(card => {
                    userTotalNormal += card.normal;
                    userTotalFoil += card.foil;
                    if (card.normal > 0 || card.foil > 0) {
                        userUniqueCards++;
                    }
                });
                
                totalCards += userUniqueCards;
                totalNormal += userTotalNormal;
                totalFoil += userTotalFoil;
                
                // Check if user is online
                const activity = userActivities[user.id];
                const isOnline = activity && activity.isOnline && 
                    (Date.now() - activity.lastActivity < 60000); // Active in last minute
                
                const lastActivity = activity ? new Date(activity.lastActivity) : null;
                const lastActivityString = lastActivity ? 
                    `${lastActivity.toLocaleDateString()} ${lastActivity.toLocaleTimeString()}` : 
                    'Never';
                
                const row = document.createElement('tr');
                if (isOnline) {
                    row.classList.add('active-user');
                }
                
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${isOnline ? '<span style="color: var(--success-color);">● Online</span>' : '<span style="color: #6c757d;">● Offline</span>'}</td>
                    <td>${userCollection.length}</td>
                    <td>${userTotalNormal}</td>
                    <td>${userTotalFoil}</td>
                    <td>${userUniqueCards}</td>
                    <td>${lastActivityString}</td>
                `;
                userStatsTableBody.appendChild(row);
            });
            
            // Update all users stats
            allUsersTotalEl.textContent = allUsers.length;
            allUsersCardsEl.textContent = totalCards;
            allUsersNormalEl.textContent = totalNormal;
            allUsersFoilEl.textContent = totalFoil;
        }

        // Refresh user data
        function refreshUserData() {
            if (currentView === 'all') {
                loadAggregatedCollection();
                loadUserActivities();
                applyFilters();
                updateStats();
                showNotification('User data refreshed!');
            } else {
                showNotification('Switch to All Users view to refresh data', true);
            }
        }

        // Save user's collection
        function saveUserCollection() {
            if (!currentUser) return;
            
            const userCollectionKey = `lorcanaCollection_${currentUser.id}`;
            localStorage.setItem(userCollectionKey, JSON.stringify(cards));
        }

        // Show notification
        function showNotification(message, isError = false, duration = 3000) {
            notification.textContent = message;
            notification.classList.toggle('error', isError);
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        // Update cloud status
        function updateCloudStatus() {
            if (cloudSettings.token && cloudSettings.gistId) {
                cloudStatusIndicator.classList.add('connected');
                cloudStatusIndicator.classList.remove('error');
                cloudStatusText.textContent = 'Connected to cloud storage';
            } else if (cloudSettings.token) {
                cloudStatusIndicator.classList.remove('connected', 'error');
                cloudStatusText.textContent = 'Cloud configured, no Gist ID';
            } else {
                cloudStatusIndicator.classList.remove('connected');
                cloudStatusIndicator.classList.add('error');
                cloudStatusText.textContent = 'Not connected to cloud storage';
            }
        }

        // Open cloud settings modal
        function openCloudSettings() {
            if (!currentUser) {
                showNotification('Please log in to use cloud storage', true);
                return;
            }
            
            githubTokenInput.value = cloudSettings.token;
            gistIdInput.value = cloudSettings.gistId;
            cloudModal.style.display = 'block';
        }

        // Close cloud settings modal
        function closeCloudModal() {
            cloudModal.style.display = 'none';
        }

        // Open user database settings modal
        function openUserDbSettings() {
            userDbTokenInput.value = userDbSettings.token;
            userDbGistIdInput.value = userDbSettings.gistId;
            userDbModal.style.display = 'block';
        }

        // Close user database settings modal
        function closeUserDbModal() {
            userDbModal.style.display = 'none';
        }

        // Open real-time settings modal
        function openRealtimeSettings() {
            if (!currentUser) {
                showNotification('Please log in to configure real-time settings', true);
                return;
            }
            
            realtimeTokenInput.value = realtimeSettings.token;
            realtimeGistIdInput.value = realtimeSettings.gistId;
            syncIntervalInput.value = realtimeSettings.syncInterval;
            realtimeModal.style.display = 'block';
        }

        // Close real-time settings modal
        function closeRealtimeModal() {
            realtimeModal.style.display = 'none';
        }

        // Save cloud settings
        function saveCloudSettings() {
            cloudSettings.token = githubTokenInput.value;
            cloudSettings.gistId = gistIdInput.value;
            
            localStorage.setItem('githubToken', cloudSettings.token);
            localStorage.setItem('githubId', cloudSettings.gistId);
            
            updateCloudStatus();
            closeCloudModal();
            showNotification('Cloud settings saved!');
        }

        // Save user database settings
        function saveUserDbSettings() {
            userDbSettings.token = userDbTokenInput.value;
            userDbSettings.gistId = userDbGistIdInput.value;
            
            localStorage.setItem('userDbToken', userDbSettings.token);
            localStorage.setItem('userDbGistId', userDbSettings.gistId);
            
            closeUserDbModal();
            showNotification('User database settings saved!');
        }

        // Save real-time settings
        function saveRealtimeSettings() {
            realtimeSettings.token = realtimeTokenInput.value;
            realtimeSettings.gistId = realtimeGistIdInput.value;
            realtimeSettings.syncInterval = parseInt(syncIntervalInput.value);
            
            localStorage.setItem('realtimeToken', realtimeSettings.token);
            localStorage.setItem('realtimeGistId', realtimeSettings.gistId);
            localStorage.setItem('syncInterval', realtimeSettings.syncInterval);
            
            // Restart real-time sync with new settings
            stopRealtimeSync();
            startRealtimeSync();
            
            closeRealtimeModal();
            showNotification('Real-time settings saved!');
        }

        // Save to cloud (GitHub Gist)
        async function saveToCloud() {
            if (!currentUser) {
                showNotification('Please log in to use cloud storage', true);
                return;
            }
            
            if (!cloudSettings.token) {
                showNotification('Please configure cloud settings first.', true);
                openCloudSettings();
                return;
            }
            
            try {
                const data = {
                    description: `Lorcana Card Collection - ${currentUser.username}`,
                    public: false,
                    files: {
                        'lorcana-collection.json': {
                            content: JSON.stringify(cards)
                        }
                    }
                };
                
                let url;
                let method;
                
                if (cloudSettings.gistId) {
                    // Update existing gist
                    url = `https://api.github.com/gists/${cloudSettings.gistId}`;
                    method = 'PATCH';
                } else {
                    // Create new gist
                    url = 'https://api.github.com/gists';
                    method = 'POST';
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `token ${cloudSettings.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                const gistData = await response.json();
                
                // Save gist ID if this was a new gist
                if (!cloudSettings.gistId) {
                    cloudSettings.gistId = gistData.id;
                    localStorage.setItem('githubId', cloudSettings.gistId);
                    updateCloudStatus();
                }
                
                showNotification('Collection saved to cloud!');
            } catch (error) {
                showNotification(`Error saving to cloud: ${error.message}`, true);
                console.error(error);
            }
        }

        // Load from cloud (GitHub Gist)
        async function loadFromCloud() {
            if (!currentUser) {
                showNotification('Please log in to use cloud storage', true);
                return;
            }
            
            if (!cloudSettings.token || !cloudSettings.gistId) {
                showNotification('Please configure cloud settings first.', true);
                openCloudSettings();
                return;
            }
            
            try {
                const response = await fetch(`https://api.github.com/gists/${cloudSettings.gistId}`, {
                    headers: {
                        'Authorization': `token ${cloudSettings.token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                const gistData = await response.json();
                const fileContent = gistData.files['lorcana-collection.json'].content;
                const loadedCards = JSON.parse(fileContent);
                
                // Update cards
                cards = loadedCards;
                filteredCards = [...cards];
                resetFilters();
                populateSetFilter();
                renderTable();
                updateStats();
                
                // Save to user's local storage
                saveUserCollection();
                
                showNotification('Collection loaded from cloud!');
            } catch (error) {
                showNotification(`Error loading from cloud: ${error.message}`, true);
                console.error(error);
            }
        }

        // Populate set filter dropdown
        function populateSetFilter() {
            const sets = [...new Set(cards.map(card => card.set))].sort();
            setFilter.innerHTML = '<option value="">All Sets</option>';
            sets.forEach(set => {
                const option = document.createElement('option');
                option.value = set;
                option.textContent = `Set ${set}`;
                setFilter.appendChild(option);
            });
        }

        // Render the card table
        function renderTable() {
            cardTableBody.innerHTML = '';
            
            if (filteredCards.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="8" style="text-align: center;">No cards found. Try adjusting your filters or uploading a new CSV file.</td>';
                cardTableBody.appendChild(row);
                return;
            }
            
            filteredCards.forEach(card => {
                const row = document.createElement('tr');
                
                // Combine colors if needed
                const colorClass = `color-${card.color_1.toLowerCase()}`;
                const colorText = card.color_2 ? `${card.color_1}/${card.color_2}` : card.color_1;
                
                // Rarity class for styling
                const rarityClass = `rarity ${card.rarity.toLowerCase().replace(' ', '-')}`;
                
                // For all users view, show additional info
                let additionalInfo = '';
                if (currentView === 'all' && card.userCount) {
                    additionalInfo = ` <small>(${card.userCount} user${card.userCount > 1 ? 's' : ''})</small>`;
                }
                
                row.innerHTML = `
                    <td>${card.name}</td>
                    <td>${card.subtitle}</td>
                    <td>${card.set}</td>
                    <td>${card.card_number}</td>
                    <td class="${colorClass}">${colorText}</td>
                    <td class="${rarityClass}">${card.rarity}</td>
                    <td><input type="number" min="0" class="count-input" data-id="${card.set}-${card.card_number}" data-type="normal" value="${card.normal}" ${!currentUser || currentView === 'all' ? 'disabled' : ''}>${additionalInfo}</td>
                    <td><input type="number" min="0" class="count-input" data-id="${card.set}-${card.card_number}" data-type="foil" value="${card.foil}" ${!currentUser || currentView === 'all' ? 'disabled' : ''}></td>
                `;
                
                cardTableBody.appendChild(row);
            });
            
            // Add event listeners to count inputs
            document.querySelectorAll('.count-input:not([disabled])').forEach(input => {
                input.addEventListener('change', handleCountChange);
            });
        }

        // Handle count changes
        async function handleCountChange(event) {
            const input = event.target;
            const id = input.dataset.id;
            const type = input.dataset.type;
            const value = parseInt(input.value) || 0;
            
            const [set, cardNumber] = id.split('-');
            const card = cards.find(c => c.set === set && c.card_number === cardNumber);
            
            if (card) {
                const oldValue = card[type];
                card[type] = value;
                
                // Update UI
                updateStats();
                saveUserCollection();
                
                // If value changed, log activity and sync to real-time data
                if (oldValue !== value) {
                    await logUserActivity('update', { cardName: card.name, set: card.set, cardNumber: card.card_number });
                    
                    // Update real-time data
                    if (realtimeSettings.token && currentUser) {
                        try {
                            const realtimeData = await getRealtimeDataFromCloud();
                            
                            if (!realtimeData.collections) {
                                realtimeData.collections = {};
                            }
                            
                            if (!realtimeData.collections[currentUser.id]) {
                                realtimeData.collections[currentUser.id] = [];
                            }
                            
                            // Find and update the card in real-time data
                            const realtimeCard = realtimeData.collections[currentUser.id].find(c => 
                                c.set === card.set && c.card_number === card.card_number
                            );
                            
                            if (realtimeCard) {
                                realtimeCard[type] = value;
                            } else {
                                realtimeData.collections[currentUser.id].push({
                                    name: card.name,
                                    subtitle: card.subtitle,
                                    set: card.set,
                                    card_number: card.card_number,
                                    color_1: card.color_1,
                                    color_2: card.color_2,
                                    rarity: card.rarity,
                                    normal: card.normal,
                                    foil: card.foil
                                });
                            }
                            
                            // Update last update time
                            realtimeData.lastUpdate = Date.now();
                            
                            // Save to cloud
                            await saveRealtimeDataToCloud(realtimeData);
                        } catch (error) {
                            console.error('Error updating real-time data:', error);
                        }
                    }
                }
            }
        }

        // Apply filters
        function applyFilters() {
            const nameValue = nameFilter.value.toLowerCase();
            const subtitleValue = subtitleFilter.value.toLowerCase();
            const setValue = setFilter.value;
            const colorValue = colorFilter.value;
            const rarityValue = rarityFilter.value;
            
            filteredCards = cards.filter(card => {
                const nameMatch = card.name.toLowerCase().includes(nameValue);
                const subtitleMatch = card.subtitle.toLowerCase().includes(subtitleValue);
                const setMatch = !setValue || card.set === setValue;
                const colorMatch = !colorValue || 
                    card.color_1 === colorValue || 
                    (card.color_2 && card.color_2 === colorValue) ||
                    (card.color_1 === colorValue.split('/')[0] && card.color_2 === colorValue.split('/')[1]);
                const rarityMatch = !rarityValue || card.rarity === rarityValue;
                
                return nameMatch && subtitleMatch && setMatch && colorMatch && rarityMatch;
            });
            
            // Reapply current sort
            if (sortColumn) {
                handleSort(sortColumn, true);
            } else {
                renderTable();
                updateStats();
            }
        }

        // Handle sorting
        function handleSort(column, keepDirection = false) {
            if (!keepDirection && sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else if (!keepDirection) {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            // Update header classes
            document.querySelectorAll('.sortable').forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
                if (header.dataset.column === column) {
                    header.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
            
            // Sort the cards
            filteredCards.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                // Handle numeric values
                if (column === 'card_number') {
                    aVal = parseInt(aVal);
                    bVal = parseInt(bVal);
                }
                
                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            renderTable();
            updateStats();
        }

        // Reset filters
        function resetFilters() {
            nameFilter.value = '';
            subtitleFilter.value = '';
            setFilter.value = '';
            colorFilter.value = '';
            rarityFilter.value = '';
            
            filteredCards = [...cards];
            renderTable();
            updateStats();
        }

        // Update statistics
        function updateStats() {
            if (currentView === 'my') {
                let totalNormal = 0;
                let totalFoil = 0;
                let uniqueCards = 0;
                
                filteredCards.forEach(card => {
                    totalNormal += card.normal;
                    totalFoil += card.foil;
                    if (card.normal > 0 || card.foil > 0) {
                        uniqueCards++;
                    }
                });
                
                totalCardsEl.textContent = filteredCards.length;
                totalNormalEl.textContent = totalNormal;
                totalFoilEl.textContent = totalFoil;
                uniqueCardsEl.textContent = uniqueCards;
            }
        }

        // Save data to localStorage
        function saveData() {
            if (!currentUser) return;
            
            saveUserCollection();
            showNotification('Collection saved locally!');
        }

        // Load data from localStorage
        function loadData() {
            if (!currentUser) return;
            
            loadUserCollection();
            showNotification('Collection loaded locally!');
        }

        // Handle CSV file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!currentUser) {
                showNotification('Please log in to upload CSV files', true);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    
                    // Show debug panel
                    debugPanel.style.display = 'block';
                    csvPreview.textContent = csv.substring(0, 1000) + (csv.length > 1000 ? '...' : '');
                    
                    // Try multiple parsing approaches
                    let newCards = [];
                    let debugText = '';
                    
                    // Approach 1: Split by newline and then by pipe
                    debugText += '=== Approach 1: Split by newline and pipe ===\n';
                    const lines1 = csv.split('\n');
                    debugText += `Total lines: ${lines1.length}\n`;
                    
                    for (let i = 0; i < lines1.length; i++) {
                        const line = lines1[i].trim();
                        if (!line) continue;
                        
                        debugText += `Line ${i}: ${line.substring(0, 50)}...\n`;
                        
                        // Skip lines that don't look like data
                        if (line.includes('{') && line.includes('}')) {
                            debugText += `Skipping line ${i}: Contains curly braces (likely filename)\n`;
                            continue;
                        }
                        
                        // Split by pipe
                        const values = line.split(/\s*\|\s*/);
                        debugText += `Values count: ${values.length}\n`;
                        
                        // Check if we have enough columns (at least 10)
                        if (values.length < 10) {
                            debugText += `Skipping line ${i}: Not enough columns\n`;
                            continue;
                        }
                        
                        // Check if the first value is a number (index)
                        if (isNaN(parseInt(values[0]))) {
                            debugText += `Skipping line ${i}: First value is not a number\n`;
                            continue;
                        }
                        
                        // Extract card data
                        const card = {
                            name: values[3],
                            subtitle: values[4],
                            set: values[5],
                            card_number: values[6],
                            color_1: values[7],
                            color_2: values[8] || "",
                            rarity: values[9],
                            normal: 0,
                            foil: 0
                        };
                        
                        debugText += `Card extracted: ${JSON.stringify(card)}\n`;
                        newCards.push(card);
                    }
                    
                    // If approach 1 didn't work, try approach 2
                    if (newCards.length === 0) {
                        debugText += '\n=== Approach 2: Split by comma ===\n';
                        const lines2 = csv.split('\n');
                        
                        for (let i = 0; i < lines2.length; i++) {
                            const line = lines2[i].trim();
                            if (!line) continue;
                            
                            debugText += `Line ${i}: ${line.substring(0, 50)}...\n`;
                            
                            // Skip header lines
                            if (line.toLowerCase().includes('name') || line.includes('{')) {
                                debugText += `Skipping line ${i}: Likely header\n`;
                                continue;
                            }
                            
                            // Split by comma
                            const values = line.split(/\s*,\s*/);
                            debugText += `Values count: ${values.length}\n`;
                            
                            // Check if we have enough columns (at least 7)
                            if (values.length < 7) {
                                debugText += `Skipping line ${i}: Not enough columns\n`;
                                continue;
                            }
                            
                            // Extract card data (adjust indices based on expected format)
                            const card = {
                                name: values[0],
                                subtitle: values[1],
                                set: values[2],
                                card_number: values[3],
                                color_1: values[4],
                                color_2: values[5] || "",
                                rarity: values[6],
                                normal: 0,
                                foil: 0
                            };
                            
                            debugText += `Card extracted: ${JSON.stringify(card)}\n`;
                            newCards.push(card);
                        }
                    }
                    
                    // If approach 2 didn't work, try approach 3
                    if (newCards.length === 0) {
                        debugText += '\n=== Approach 3: Split by tab ===\n';
                        const lines3 = csv.split('\n');
                        
                        for (let i = 0; i < lines3.length; i++) {
                            const line = lines3[i].trim();
                            if (!line) continue;
                            
                            debugText += `Line ${i}: ${line.substring(0, 50)}...\n`;
                            
                            // Skip header lines
                            if (line.toLowerCase().includes('name') || line.includes('{')) {
                                debugText += `Skipping line ${i}: Likely header\n`;
                                continue;
                            }
                            
                            // Split by tab
                            const values = line.split(/\s*\t\s*/);
                            debugText += `Values count: ${values.length}\n`;
                            
                            // Check if we have enough columns (at least 7)
                            if (values.length < 7) {
                                debugText += `Skipping line ${i}: Not enough columns\n`;
                                continue;
                            }
                            
                            // Extract card data (adjust indices based on expected format)
                            const card = {
                                name: values[0],
                                subtitle: values[1],
                                set: values[2],
                                card_number: values[3],
                                color_1: values[4],
                                color_2: values[5] || "",
                                rarity: values[6],
                                normal: 0,
                                foil: 0
                            };
                            
                            debugText += `Card extracted: ${JSON.stringify(card)}\n`;
                            newCards.push(card);
                        }
                    }
                    
                    // Display debug info
                    debugInfo.textContent = debugText;
                    
                    if (newCards.length > 0) {
                        // Preserve existing counts for cards that are already in the collection
                        const existingCardsMap = {};
                        cards.forEach(card => {
                            const key = `${card.set}-${card.card_number}`;
                            existingCardsMap[key] = {
                                normal: card.normal,
                                foil: card.foil
                            };
                        });
                        
                        // Update counts for existing cards
                        newCards.forEach(card => {
                            const key = `${card.set}-${card.card_number}`;
                            if (existingCardsMap[key]) {
                                card.normal = existingCardsMap[key].normal;
                                card.foil = existingCardsMap[key].foil;
                            }
                        });
                        
                        cards = newCards;
                        filteredCards = [...cards];
                        resetFilters();
                        populateSetFilter();
                        renderTable();
                        updateStats();
                        saveUserCollection();
                        showNotification(`Successfully loaded ${newCards.length} cards!`);
                    } else {
                        showNotification('No valid cards found in the CSV file. Check the debug panel for details.', true);
                    }
                } catch (error) {
                    showNotification('Error parsing CSV file. Please check the debug panel for details.', true);
                    debugInfo.textContent = `Error: ${error.message}\n\nStack: ${error.stack}`;
                    debugPanel.style.display = 'block';
                }
                
                // Reset the file input
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
